# Gough Hypervisor Automation System - Implementation Plan

## Project Overview
Build Gough, a hypervisor automation system using Ubuntu MaaS (as one component), custom Python 3.12 services, and Ansible to netboot hardware with Ubuntu 24.04 LTS. Named after Gough Island - home to penguins and providing them structure, just as this hypervisor gives the entire ecosystem a place to call home.

Repository: https://github.com/penguintechinc/gough

## System Architecture

### Container Architecture
1. **MaaS Container** - Ubuntu MaaS server for PXE boot and bare metal provisioning (only component using MaaS)
2. **Gough Management Server** - Custom py4web portal for hypervisor configuration and orchestration
3. **Gough Agent Container** - Custom monitoring and management agent deployed to servers
4. **FleetDM Server** - OSQuery fleet management for security monitoring

## Phase 1: Project Setup & Foundation

### 1.1 Project Structure Creation
- [x] Create main project directory: `maas-automation/`
- [x] Setup directory structure:
  ```
  maas-automation/
  ├── containers/
  │   ├── maas/
  │   │   ├── Dockerfile
  │   │   └── config/
  │   ├── management-server/
  │   │   ├── Dockerfile
  │   │   ├── py4web-app/
  │   │   └── requirements.txt
  │   ├── agent/
  │   │   ├── Dockerfile
  │   │   └── scripts/
  │   └── fleetdm/
  │       ├── Dockerfile
  │       └── config/
  ├── ansible/
  │   ├── playbooks/
  │   ├── roles/
  │   └── inventory/
  ├── cloud-init/
  │   └── templates/
  ├── docker-compose.yml
  ├── .env.example
  └── README.md
  ```

### 1.2 Environment Configuration
- [x] Create `.env` file with configuration variables
- [x] Define network configuration for containers
- [x] Setup persistent volumes for data storage

## Phase 2: MaaS Container Development

### 2.1 MaaS Container Setup
- [x] Create Dockerfile for MaaS container based on Ubuntu 24.04
- [x] Install MaaS packages:
  ```dockerfile
  RUN apt-get update && apt-get install -y \
      maas \
      postgresql \
      bind9 \
      isc-dhcp-server
  ```
- [x] Configure MaaS database connection
- [x] Setup MaaS region and rack controllers
- [x] Configure DHCP and DNS for PXE boot

### 2.2 MaaS Configuration Scripts
- [x] Create initialization script for MaaS setup
- [x] Configure network ranges and VLAN settings
- [x] Setup default Ubuntu 24.04 LTS images
- [x] Create API credentials for management server

## Phase 3: Management Server Development

### 3.1 Py4web Portal Setup
- [x] Create Dockerfile with Python 3.12
- [x] Install py4web framework
- [x] Create requirements.txt:
  ```
  py4web
  python-libmaas
  pyyaml
  requests
  celery
  redis
  ansible-runner
  ```

### 3.2 Portal Features Implementation
- [x] **Dashboard Module**
  - [x] Server inventory display
  - [x] Deployment status monitoring
  - [x] Resource utilization graphs

- [x] **MaaS Integration Module**
  - [x] Connect to MaaS API
  - [x] Machine discovery and commissioning
  - [x] Deployment workflow management
  - [x] Status polling and updates

- [x] **Configuration Management**
  - [x] Package selection interface (docker.io, lxd/lxc, etc.)
  - [x] Cloud-init template editor
  - [x] Ansible playbook configuration
  - [x] Environment variables management

- [x] **User Management**
  - [x] Authentication system
  - [x] Role-based access control
  - [x] API key management

### 3.3 Cloud-Init Integration
- [x] Create cloud-init template generator
- [x] Templates for different server roles:
  ```yaml
  # base-server.yaml
  #cloud-config
  package_update: true
  packages:
    - python3-pip
    - curl
    - wget
    - git
  
  # docker-server.yaml
  packages:
    - docker.io
    - docker-compose
  
  # lxd-server.yaml
  packages:
    - lxd
    - lxc
  ```
- [x] Dynamic template rendering based on portal configuration
- [x] Integration with MaaS user-data

## Phase 4: Agent Container Development

### 4.1 Agent Container Design
- [x] Create lightweight agent Dockerfile (Alpine or Ubuntu minimal)
- [x] Install required tools:
  ```dockerfile
  RUN apt-get update && apt-get install -y \
      python3-minimal \
      python3-pip \
      curl \
      systemd
  ```

### 4.2 Agent Functionality
- [x] System monitoring scripts
- [x] Configuration management client
- [x] Log collection and forwarding
- [x] Remote command execution capability
- [x] Health check endpoints

### 4.3 Agent Deployment Method
- [x] Create deployment script via cloud-init
- [x] SystemD service configuration
- [x] Auto-registration with management server
- [x] Secure communication setup (TLS/mTLS)

## Phase 5: FleetDM & OSQuery Integration

### 5.1 FleetDM Server Setup
- [x] Create FleetDM container configuration
- [x] Setup MySQL/PostgreSQL backend
- [x] Configure Redis for live queries
- [x] SSL/TLS certificate configuration
- [x] Create enrollment secrets

### 5.2 OSQuery Agent Deployment
- [x] Create OSQuery installation playbook
- [ ] Configure OSQuery flags:
  ```
  --tls_server_certs=/etc/osquery/certs/
  --tls_hostname=fleetdm.local
  --host_identifier=uuid
  --enroll_secret_path=/etc/osquery/enroll_secret
  ```
- [ ] Create query packs for monitoring
- [ ] Setup automatic enrollment process

### 5.3 Integration with Management Portal
- [ ] Add FleetDM API integration
- [ ] Display OSQuery results in dashboard
- [ ] Alert configuration interface
- [ ] Query builder interface

## Phase 6: Ansible Orchestration

### 6.1 Playbook Development
- [ ] **site.yml** - Main orchestration playbook
- [ ] **provision-server.yml** - Server provisioning via MaaS
- [ ] **deploy-agent.yml** - Agent container deployment
- [ ] **configure-packages.yml** - Package installation based on config
- [ ] **deploy-osquery.yml** - OSQuery agent installation
- [ ] **update-fleet.yml** - Fleet configuration updates

### 6.2 Role Creation
- [ ] **maas-provision** - Handle MaaS API calls
- [ ] **cloud-init-config** - Generate and apply cloud-init
- [ ] **docker-setup** - Docker installation and configuration
- [ ] **lxd-setup** - LXD/LXC installation
- [ ] **agent-deploy** - Agent container deployment
- [ ] **osquery-install** - OSQuery and FleetDM enrollment

### 6.3 Dynamic Inventory
- [ ] Create MaaS dynamic inventory script
- [ ] Group hosts by tags and roles
- [ ] Variable management for different environments

## Phase 7: Docker Compose Configuration

### 7.1 Services Definition
```yaml
version: '3.8'
services:
  maas:
    build: ./containers/maas
    ports:
      - "5240:5240"
    volumes:
      - maas-data:/var/lib/maas
    networks:
      - maas-net

  management-server:
    build: ./containers/management-server
    ports:
      - "8000:8000"
    environment:
      - MAAS_API_URL=${MAAS_API_URL}
      - MAAS_API_KEY=${MAAS_API_KEY}
    depends_on:
      - maas
      - redis
    networks:
      - maas-net

  fleetdm:
    build: ./containers/fleetdm
    ports:
      - "8080:8080"
    environment:
      - FLEET_MYSQL_ADDRESS=${MYSQL_ADDRESS}
    depends_on:
      - mysql
    networks:
      - maas-net

  redis:
    image: redis:alpine
    networks:
      - maas-net

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=fleet
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - maas-net
```

### 7.2 Network Configuration
- [ ] Create isolated network for containers
- [ ] Configure bridge for PXE boot network
- [ ] Setup firewall rules

## Phase 8: Implementation Tasks

### 8.1 Core Development
- [ ] Implement MaaS API wrapper library
- [ ] Create py4web application structure
- [ ] Develop REST API endpoints
- [ ] Build frontend UI with templates
- [ ] Create background job processing with Celery

### 8.2 Integration Development
- [ ] MaaS webhook handlers for provisioning events
- [ ] Cloud-init template processing engine
- [ ] Ansible callback plugins for status updates
- [ ] FleetDM query scheduler
- [ ] Logging aggregation system

### 8.3 Security Implementation
- [ ] API authentication (JWT/OAuth2)
- [ ] TLS certificates for all services
- [ ] Secrets management (HashiCorp Vault integration)
- [ ] Network segmentation
- [ ] Audit logging

## Phase 9: Testing & Validation

### 9.1 Unit Testing
- [ ] Python unit tests for management server
- [ ] API endpoint testing
- [ ] Cloud-init template validation
- [ ] Ansible playbook syntax checking

### 9.2 Integration Testing
- [ ] MaaS provisioning workflow testing
- [ ] Agent deployment validation
- [ ] Package installation verification
- [ ] OSQuery enrollment testing
- [ ] End-to-end provisioning test

### 9.3 Performance Testing
- [ ] Load testing for management portal
- [ ] Concurrent provisioning stress test
- [ ] Database performance optimization
- [ ] Network throughput testing

## Phase 10: Documentation & Deployment

### 10.1 Documentation
- [ ] System architecture documentation
- [ ] API documentation (OpenAPI/Swagger)
- [ ] User guide for management portal
- [ ] Ansible playbook documentation
- [ ] Troubleshooting guide
- [ ] Security best practices

### 10.2 Deployment Procedures
- [ ] Production deployment checklist
- [ ] Backup and restore procedures
- [ ] Monitoring setup (Prometheus/Grafana)
- [ ] Log aggregation (ELK stack)
- [ ] Disaster recovery plan

### 10.3 CI/CD Pipeline
- [ ] GitLab/GitHub CI configuration
- [ ] Automated testing pipeline
- [ ] Container image building
- [ ] Automated deployment to staging
- [ ] Production deployment approval workflow

## Phase 11: Production Readiness

### 11.1 High Availability
- [ ] MaaS HA configuration
- [ ] Database replication setup
- [ ] Load balancer configuration
- [ ] Container orchestration (Kubernetes option)

### 11.2 Monitoring & Alerting
- [ ] Prometheus metrics collection
- [ ] Grafana dashboard creation
- [ ] Alert rules configuration
- [ ] PagerDuty/Slack integration

### 11.3 Maintenance Procedures
- [ ] Update procedures for Ubuntu images
- [ ] Container image update workflow
- [ ] Database maintenance scripts
- [ ] Log rotation configuration

## Success Criteria

1. **Automated Provisioning**: Ability to netboot and provision Ubuntu 24.04 LTS on bare metal
2. **Web Management**: Functional py4web portal for configuration and monitoring
3. **Package Management**: Dynamic package installation via cloud-init
4. **Agent Deployment**: Automatic agent container deployment to provisioned servers
5. **Fleet Monitoring**: Working FleetDM server with OSQuery agents reporting
6. **API Integration**: Full MaaS API integration with management portal
7. **Scalability**: Support for provisioning 100+ servers concurrently
8. **Security**: TLS encryption, authentication, and audit logging
9. **Documentation**: Complete documentation for all components
10. **Testing**: 80% code coverage and passing integration tests

## Timeline Estimate (Claude doing 80% of development work)

- **Phase 1-2**: Week 1 (Foundation & MaaS) - Claude: 80%, Human: 20% (direction/testing)
- **Phase 3-4**: Week 2 (Management Server & Agent) - Claude: 80%, Human: 20% (direction/testing)
- **Phase 5-6**: Week 3 (FleetDM & Ansible) - Claude: 80%, Human: 20% (direction/testing)
- **Phase 7-8**: Week 4-5 (Integration & Development) - Claude: 80%, Human: 20% (direction/testing)
- **Phase 9**: Week 6 (Testing) - Claude: 70%, Human: 30% (manual testing/security assessment)
- **Phase 10**: Week 7 (Documentation & Marketing) - Claude: 90%, Human: 10% (review/direction)
- **Phase 11**: Week 8 (Production Readiness) - Claude: 60%, Human: 40% (deployment/validation)

Total estimated time: 8 weeks with 80/20 development split

## Additional Deliverables

### Phase 12: Marketing & Sales Website
- [ ] Create Node.js marketing website for Cloudflare Pages deployment
- [ ] Product landing page with feature overview
- [ ] Technical documentation and API references
- [ ] Pricing and contact information
- [ ] Integration with GitHub repository

### Phase 13: Comprehensive Documentation
- [ ] Create complete documentation package in docs/ folder
- [ ] Installation and deployment guides  
- [ ] API documentation with examples
- [ ] Architecture diagrams and system design
- [ ] Troubleshooting and FAQ sections
- [ ] Security best practices guide

## Additional Context From User
- github is github.com/penguintechinc/gough
- The name is from Gough Island, the home island of the Northern Rockhopper and the foundation of said penguins
- sales email is sales@penguintech.io
- Enterprise version is $5/compute node (Cloud VM or Server) per month,  discounts starting at 100 nodes+
- The base layer we are working on now is open source AGPL3.0 for personal or internal company (non-sales related) use cases, otherwise license required
- Prefer the containers be in their own folder at the top level or in a services folder... either or is fine

## Next Steps

1. Review and approve the implementation plan
2. Setup development environment
3. Begin with Phase 1 project structure creation
4. Establish CI/CD pipeline early
5. Create proof of concept for MaaS integration