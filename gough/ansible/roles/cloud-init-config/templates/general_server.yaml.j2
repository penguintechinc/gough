#cloud-config
# Cloud-Init configuration for General Purpose servers
# Generated by Gough Hypervisor Automation System
# Role: {{ server_role }}
# Environment: {{ server_environment }}
# Created: {{ ansible_date_time.iso8601 }}

hostname: {{ hostname_prefix }}-server-{{ '%03d' | format(loop_index | default(1)) }}
fqdn: {{ hostname_prefix }}-server-{{ '%03d' | format(loop_index | default(1)) }}.{{ domain_name }}

# Locale and timezone
locale: {{ locale }}
timezone: {{ timezone }}

# Package management
package_update: true
package_upgrade: true
package_reboot_if_required: true

# Packages to install
packages:
{% for package in packages_to_install %}
  - {{ package }}
{% endfor %}

# Users configuration
users:
  - default
{% for user in users_to_create %}
  - name: {{ user.name }}
    groups: {{ user.groups | join(',') }}
    shell: {{ user.shell | default('/bin/bash') }}
    sudo: {{ user.sudo | default('ALL=(ALL) NOPASSWD:ALL') }}
    ssh_authorized_keys:
      - {{ ssh_authorized_key }}
{% endfor %}

# SSH configuration
ssh_authorized_keys:
  - {{ ssh_authorized_key }}

# System configuration files
write_files:
{% for file in files_to_create %}
  - path: {{ file.path }}
    content: |
{{ file.content | indent(6, True) }}
    permissions: '{{ file.permissions }}'
    owner: {{ file.owner }}
{% endfor %}
  - path: /opt/gough/server-setup.sh
    content: |
      #!/bin/bash
      # General server post-installation setup
      set -euo pipefail
      
      # System optimization
      echo 'vm.swappiness=10' >> /etc/sysctl.conf
      echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf
      echo 'net.core.rmem_default=262144' >> /etc/sysctl.conf
      echo 'net.core.rmem_max=16777216' >> /etc/sysctl.conf
      echo 'net.core.wmem_default=262144' >> /etc/sysctl.conf
      echo 'net.core.wmem_max=16777216' >> /etc/sysctl.conf
      
      # Security hardening
      echo 'net.ipv4.conf.all.accept_redirects=0' >> /etc/sysctl.conf
      echo 'net.ipv4.conf.all.send_redirects=0' >> /etc/sysctl.conf
      echo 'net.ipv4.conf.all.accept_source_route=0' >> /etc/sysctl.conf
      echo 'net.ipv4.conf.all.log_martians=1' >> /etc/sysctl.conf
      echo 'net.ipv4.icmp_echo_ignore_broadcasts=1' >> /etc/sysctl.conf
      echo 'net.ipv4.icmp_ignore_bogus_error_responses=1' >> /etc/sysctl.conf
      echo 'net.ipv4.tcp_syncookies=1' >> /etc/sysctl.conf
      
      # Apply sysctl changes
      sysctl -p
      
      # Configure automatic updates
      echo 'Unattended-Upgrade::Automatic-Reboot "false";' >> /etc/apt/apt.conf.d/50unattended-upgrades
      echo 'Unattended-Upgrade::Remove-Unused-Dependencies "true";' >> /etc/apt/apt.conf.d/50unattended-upgrades
      
      systemctl enable unattended-upgrades
      
      # Setup log rotation
      cat > /etc/logrotate.d/gough-server << EOF
      /var/log/gough/*.log {
          daily
          rotate 14
          compress
          delaycompress
          missingok
          notifempty
          create 644 syslog syslog
      }
      EOF
      
      # Verify system status
      systemctl status ssh
      systemctl status ntp
      systemctl status fail2ban
      
      echo "General server setup completed successfully"
    permissions: '0755'
    owner: root:root

# Commands to run
runcmd:
{% for command in commands_to_run %}
  - {{ command }}
{% endfor %}
  # General server setup
  - /opt/gough/server-setup.sh
  # Firewall configuration
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow from {{ management_subnet | default('172.20.0.0/16') }} to any port 22
  - ufw --force enable
  # Install Gough agent
  - curl -fsSL {{ management_server_url | default('http://management-server:8000') }}/static/install-agent.sh | bash -s -- --role general_server --env {{ server_environment }}

# Services to enable and start
runcmd:
{% for service in services_to_enable %}
  - systemctl enable {{ service }}
  - systemctl start {{ service }}
{% endfor %}

# Network configuration
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: {{ dhcp_enabled }}
{% if not dhcp_enabled and static_ip %}
      addresses:
        - {{ static_ip }}
      gateway4: {{ gateway }}
      nameservers:
        addresses: {{ dns_servers }}
{% endif %}

# Final message
final_message: |
  Gough General Server provisioning complete!
  
  Server Details:
  - Hostname: {{ hostname_prefix }}-server-{{ '%03d' | format(loop_index | default(1)) }}
  - Role: {{ server_role }}
  - Environment: {{ server_environment }}
  - OS: $(lsb_release -d | cut -f2)
  - Kernel: $(uname -r)
  - System uptime: $(uptime)
  
  System is hardened and ready for use.
  Gough management agent has been installed.
  
  System provisioned at: {{ ansible_date_time.iso8601 }}

# Power management
power_state:
  mode: reboot
  condition: True
  delay: "+1"
  message: "Rebooting after cloud-init setup"