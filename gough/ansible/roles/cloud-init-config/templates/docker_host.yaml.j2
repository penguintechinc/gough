#cloud-config
# Cloud-Init configuration for Docker Host servers
# Generated by Gough Hypervisor Automation System
# Role: {{ server_role }}
# Environment: {{ server_environment }}
# Created: {{ ansible_date_time.iso8601 }}

hostname: {{ hostname_prefix }}-docker-{{ '%03d' | format(loop_index | default(1)) }}
fqdn: {{ hostname_prefix }}-docker-{{ '%03d' | format(loop_index | default(1)) }}.{{ domain_name }}

# Locale and timezone
locale: {{ locale }}
timezone: {{ timezone }}

# Package management
package_update: true
package_upgrade: true
package_reboot_if_required: true

# Packages to install
packages:
{% for package in packages_to_install %}
  - {{ package }}
{% endfor %}

# Users configuration
users:
  - default
{% for user in users_to_create %}
  - name: {{ user.name }}
    groups: {{ user.groups | join(',') }}
    shell: {{ user.shell | default('/bin/bash') }}
    sudo: {{ user.sudo | default('ALL=(ALL) NOPASSWD:ALL') }}
    ssh_authorized_keys:
      - {{ ssh_authorized_key }}
{% endfor %}

# SSH configuration
ssh_authorized_keys:
  - {{ ssh_authorized_key }}

# System configuration files
write_files:
{% for file in files_to_create %}
  - path: {{ file.path }}
    content: |
{{ file.content | indent(6, True) }}
    permissions: '{{ file.permissions }}'
    owner: {{ file.owner }}
{% endfor %}
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "storage-driver": "overlay2",
        "insecure-registries": ["{{ docker_registry | default('registry.gough.local:5000') }}"],
        "metrics-addr": "0.0.0.0:9323",
        "experimental": false
      }
    permissions: '0644'
    owner: root:root
  - path: /etc/systemd/system/docker.service.d/override.conf
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2376
    permissions: '0644'
    owner: root:root
  - path: /opt/gough/docker-setup.sh
    content: |
      #!/bin/bash
      # Docker post-installation setup
      set -euo pipefail
      
      # Add users to docker group
{% for user in users_to_create %}
      usermod -aG docker {{ user.name }}
{% endfor %}
      usermod -aG docker ubuntu
      
      # Configure Docker Compose
      curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" \
        -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
      
      # Install Docker Buildx
      mkdir -p ~/.docker/cli-plugins
      curl -L "https://github.com/docker/buildx/releases/download/v0.11.0/buildx-v0.11.0.linux-amd64" \
        -o ~/.docker/cli-plugins/docker-buildx
      chmod +x ~/.docker/cli-plugins/docker-buildx
      
      # Start and enable Docker
      systemctl daemon-reload
      systemctl enable docker
      systemctl start docker
      
      # Verify installation
      docker --version
      docker-compose --version
      docker info
    permissions: '0755'
    owner: root:root

# Commands to run
runcmd:
{% for command in commands_to_run %}
  - {{ command }}
{% endfor %}
  # Docker-specific setup
  - /opt/gough/docker-setup.sh
  - systemctl enable docker
  - systemctl start docker
  # Firewall configuration for Docker
  - ufw allow 2376/tcp comment "Docker daemon"
  - ufw allow 2377/tcp comment "Docker swarm management"
  - ufw allow 7946/tcp comment "Docker swarm node communication"
  - ufw allow 7946/udp comment "Docker swarm node communication"
  - ufw allow 4789/udp comment "Docker overlay network"
  # Install Gough agent
  - curl -fsSL {{ management_server_url | default('http://management-server:8000') }}/static/install-agent.sh | bash -s -- --role docker_host --env {{ server_environment }}

# Services to enable
services:
{% for service in services_to_enable %}
  - {{ service }}
{% endfor %}

# Network configuration
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: {{ dhcp_enabled }}
{% if not dhcp_enabled and static_ip %}
      addresses:
        - {{ static_ip }}
      gateway4: {{ gateway }}
      nameservers:
        addresses: {{ dns_servers }}
{% endif %}

# Final message
final_message: |
  Gough Docker Host provisioning complete!
  
  Server Details:
  - Hostname: {{ hostname_prefix }}-docker-{{ '%03d' | format(loop_index | default(1)) }}
  - Role: {{ server_role }}
  - Environment: {{ server_environment }}
  - Docker version: $(docker --version)
  - System uptime: $(uptime)
  
  Docker services are running and configured.
  Gough management agent has been installed.
  
  System provisioned at: {{ ansible_date_time.iso8601 }}

# Power management
power_state:
  mode: reboot
  condition: True
  delay: "+1"
  message: "Rebooting after cloud-init setup"