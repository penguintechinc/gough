---
# Cloud-Init Configuration Role - Variables

# Base packages for all server types
base_packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - tree
  - unzip
  - python3-pip
  - python3-venv
  - rsync
  - jq
  - net-tools
  - ntp
  - fail2ban
  - ufw
  - ca-certificates
  - apt-transport-https
  - gnupg
  - lsb-release
  - software-properties-common

# Role-specific packages
cloud_init_packages:
  docker_host:
    - docker.io
    - docker-compose
    - containerd
  kubernetes_node:
    - kubelet
    - kubeadm
    - kubectl
    - docker.io
  lxd_host:
    - lxd
    - lxc
    - lxc-templates
    - bridge-utils
  general_server:
    - build-essential
    - python3-dev

# Environment-specific packages
env_packages:
  development:
    - nodejs
    - npm
    - golang-go
    - terraform
    - ansible
  staging:
    - monitoring-agent
    - log-shipper
  production:
    - aide
    - lynis
    - chkrootkit
    - rkhunter

# Base services to enable
base_services:
  - ssh
  - ntp
  - fail2ban
  - rsyslog
  - ufw

# Role-specific services
cloud_init_services:
  docker_host:
    - docker
    - containerd
  kubernetes_node:
    - docker
    - kubelet
  lxd_host:
    - lxd
    - lxc
  general_server: []

# Base users to create
base_users:
  - name: gough
    groups: 
      - sudo
      - adm
    shell: /bin/bash
    sudo: 'ALL=(ALL) NOPASSWD:ALL'

# Role-specific users
cloud_init_users:
  docker_host:
    - name: docker-admin
      groups: 
        - docker
        - sudo
      shell: /bin/bash
  kubernetes_node:
    - name: k8s-admin
      groups: 
        - sudo
      shell: /bin/bash
  lxd_host:
    - name: lxd-admin
      groups: 
        - lxd
        - sudo
      shell: /bin/bash
  general_server: []

# Base commands to run
base_commands:
  - systemctl enable ssh
  - systemctl start ssh
  - ufw --force enable
  - ufw allow ssh

# Role-specific commands
cloud_init_commands:
  docker_host:
    - usermod -aG docker gough
    - systemctl enable docker
    - systemctl start docker
    - docker --version
  kubernetes_node:
    - kubeadm config images pull
    - systemctl enable kubelet
    - swapoff -a
    - sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  lxd_host:
    - usermod -aG lxd gough
    - lxd init --auto
    - lxc config set core.https_address '[::]:8443'
  general_server:
    - apt update && apt upgrade -y

# Base files to create
base_files:
  - path: /etc/gough/agent-config.yml
    content: |
      server_role: "{{ server_role }}"
      environment: "{{ server_environment }}"
      management_server: "{{ management_server_url | default('') }}"
    permissions: '0640'
    owner: 'gough:gough'
  - path: /etc/motd
    content: |
      Welcome to Gough Managed Server
      ==============================
      
      Server Role: {{ server_role }}
      Environment: {{ server_environment }}
      Provisioned: {{ ansible_date_time.iso8601 }}
      
      This server is managed by Gough Hypervisor Automation System.
      For support, contact: {{ support_contact | default('admin@gough.local') }}
      ==============================
    permissions: '0644'
    owner: 'root:root'

# Role-specific files
cloud_init_files:
  docker_host:
    - path: /etc/docker/daemon.json
      content: |
        {
          "log-driver": "json-file",
          "log-opts": {
            "max-size": "10m",
            "max-file": "3"
          },
          "storage-driver": "overlay2"
        }
      permissions: '0644'
      owner: 'root:root'
  kubernetes_node:
    - path: /etc/kubernetes/kubelet.conf
      content: |
        apiVersion: kubelet.config.k8s.io/v1beta1
        kind: KubeletConfiguration
        cgroupDriver: systemd
        serverTLSBootstrap: true
      permissions: '0644'
      owner: 'root:root'
  lxd_host:
    - path: /etc/lxd/lxd.conf
      content: |
        config:
          core.https_address: '[::]:8443'
          core.trust_password: "{{ lxd_password | default('changeme') }}"
      permissions: '0600'
      owner: 'root:root'
  general_server: []

# Default configuration values
cloud_init_hostname_prefix: "gough"
cloud_init_domain: "gough.local"
cloud_init_timezone: "UTC"
cloud_init_locale: "en_US.UTF-8"
cloud_init_network_renderer: "networkd"
cloud_init_dhcp: true

# SSH key configuration
ssh_key_path: "/tmp/gough-ssh-key"