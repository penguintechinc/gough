# Gough Agent Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

# Server identification
server_id: "{{ agent_config.server_id | default(inventory_hostname) }}"
hostname: "{{ inventory_hostname }}"
server_role: "{{ agent_config.server_role | default('general_server') }}"
environment: "{{ agent_config.environment | default('development') }}"

# Management server connection
management_server:
  url: "{{ agent_config.management_server_url | default(management_server_url) }}"
  api_key: "{{ agent_config.agent_api_key }}"
  timeout: {{ agent_api_timeout | default(30) }}
  ssl_verify: {{ agent_tls_enabled | default(true) | lower }}

# Agent API configuration
api:
  bind_address: "0.0.0.0"
  port: {{ agent_api_port | default(9090) }}
  metrics_port: {{ agent_metrics_port | default(9091) }}
  ssl_enabled: {{ agent_tls_enabled | default(true) | lower }}
  certificate_path: "{{ agent_certificate_path }}"

# Monitoring configuration
monitoring:
  interval: {{ agent_config.monitoring_interval | default(60) }}
  health_check_interval: {{ health_check_interval | default(30) }}
  enabled_modules:
    - system
    - network
    - disk
    - process
{% if agent_config.enable_docker_monitoring | default(false) %}
    - docker
{% endif %}
{% if agent_config.enable_k8s_monitoring | default(false) %}
    - kubernetes
{% endif %}

# Logging configuration
logging:
  level: "{{ agent_config.log_level | default('INFO') }}"
  file: "{{ agent_log_path }}/agent.log"
  max_size: "10MB"
  max_files: 5
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# OSQuery integration
osquery:
  enabled: {{ agent_config.enable_osquery | default(true) | lower }}
  config_path: "{{ osquery_config_path }}/osquery.conf"
  flags_path: "{{ osquery_config_path }}/osquery.flags"
  enrollment_secret_path: "{{ osquery_config_path }}/enroll_secret"
  
# Fleet DM configuration
fleet:
  enabled: {{ agent_config.enable_osquery | default(true) | lower }}
  server_url: "{{ fleet_url | default('https://fleetdm:8443') }}"
  enrollment_timeout: {{ fleet_enrollment_timeout | default(300) }}

# Docker monitoring (if enabled)
{% if agent_config.enable_docker_monitoring | default(false) %}
docker:
  socket_path: "/var/run/docker.sock"
  api_version: "auto"
  collect_stats: true
  collect_logs: false
{% endif %}

# Kubernetes monitoring (if enabled)
{% if agent_config.enable_k8s_monitoring | default(false) %}
kubernetes:
  config_path: "/etc/kubernetes/admin.conf"
  namespace: "default"
  collect_metrics: true
  collect_events: true
{% endif %}

# Security settings
security:
  tls_enabled: {{ agent_tls_enabled | default(true) | lower }}
  certificate_path: "{{ agent_certificate_path }}/agent.crt"
  private_key_path: "{{ agent_certificate_path }}/agent.key"
  ca_certificate_path: "{{ agent_certificate_path }}/ca.crt"