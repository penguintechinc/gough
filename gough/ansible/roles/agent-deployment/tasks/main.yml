---
# MaaS Agent deployment tasks

- name: Create agent directories
  file:
    path: "{{ item }}"
    state: directory
    owner: maas
    group: maas
    mode: '0755'
  loop:
    - /opt/maas-agent
    - /opt/maas-agent/bin
    - /opt/maas-agent/logs
    - /opt/maas-agent/config
    - /opt/maas-agent/data

- name: Check if agent is already installed
  stat:
    path: /opt/maas-agent/bin/agent.py
  register: agent_installed

- name: Download MaaS agent
  get_url:
    url: "{{ management_server_url }}/static/downloads/maas-agent-latest.tar.gz"
    dest: /tmp/maas-agent.tar.gz
    mode: '0644'
    timeout: 30
  when: not agent_installed.stat.exists

- name: Extract agent files
  unarchive:
    src: /tmp/maas-agent.tar.gz
    dest: /opt/maas-agent
    remote_src: true
    owner: maas
    group: maas
  when: not agent_installed.stat.exists
  notify: restart maas-agent

- name: Install agent Python dependencies
  pip:
    requirements: /opt/maas-agent/requirements.txt
    executable: pip3
  when: not agent_installed.stat.exists

- name: Generate agent configuration
  template:
    src: agent-config.yaml.j2
    dest: /etc/maas-agent/config.yaml
    owner: maas
    group: maas
    mode: '0640'
  notify: restart maas-agent

- name: Generate agent environment file
  template:
    src: agent.env.j2
    dest: /etc/maas-agent/.env
    owner: maas
    group: maas
    mode: '0600'
  notify: restart maas-agent

- name: Install agent systemd service
  template:
    src: maas-agent.service.j2
    dest: /etc/systemd/system/maas-agent.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart maas-agent

- name: Enable and start agent service
  systemd:
    name: maas-agent
    state: started
    enabled: true
    daemon_reload: true

- name: Configure OSQuery for FleetDM
  block:
    - name: Install OSQuery
      apt:
        deb: https://pkg.osquery.io/deb/osquery_5.10.2-1.linux_amd64.deb
        state: present
      when: osquery_enabled | default(true)

    - name: Configure OSQuery
      template:
        src: osquery.conf.j2
        dest: /etc/osquery/osquery.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart osqueryd
      when: osquery_enabled | default(true)

    - name: Configure OSQuery flags
      template:
        src: osquery.flags.j2
        dest: /etc/osquery/osquery.flags
        owner: root
        group: root
        mode: '0644'
      notify: restart osqueryd
      when: osquery_enabled | default(true)

    - name: Get FleetDM enrollment secret
      uri:
        url: "{{ fleet_url }}/api/v1/fleet/spec/enroll_secret"
        method: GET
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        validate_certs: false
      register: enroll_secret
      when: osquery_enabled | default(true) and fleet_api_token is defined

    - name: Write OSQuery enrollment secret
      copy:
        content: "{{ enroll_secret.json.spec.secrets[0] }}"
        dest: /etc/osquery/enroll_secret
        owner: root
        group: root
        mode: '0600'
      when: osquery_enabled | default(true) and enroll_secret is defined
      notify: restart osqueryd

    - name: Enable and start OSQuery service
      systemd:
        name: osqueryd
        state: started
        enabled: true
      when: osquery_enabled | default(true)

- name: Configure agent log rotation
  copy:
    dest: /etc/logrotate.d/maas-agent
    content: |
      /opt/maas-agent/logs/*.log {
        daily
        rotate 7
        compress
        delaycompress
        missingok
        notifempty
        create 644 maas maas
        postrotate
          systemctl reload maas-agent || true
        endscript
      }
    owner: root
    group: root
    mode: '0644'

- name: Create agent monitoring script
  copy:
    dest: /usr/local/bin/maas-agent-status
    content: |
      #!/bin/bash
      echo "=== MaaS Agent Status ==="
      echo "Service status: $(systemctl is-active maas-agent)"
      echo "Agent port: $(ss -tlnp | grep :9090 | wc -l) listening"
      echo "Last heartbeat: $(journalctl -u maas-agent --since '5 minutes ago' | grep heartbeat | tail -1 | cut -d' ' -f1-3)"
      echo ""
      echo "=== Agent Logs (last 10 lines) ==="
      tail -10 /opt/maas-agent/logs/agent.log
      echo ""
      echo "=== OSQuery Status ==="
      if command -v osqueryi >/dev/null 2>&1; then
        echo "OSQuery version: $(osqueryd --version 2>&1 | head -1)"
        echo "OSQuery status: $(systemctl is-active osqueryd)"
        echo "Fleet enrollment: $(osqueryi 'SELECT * FROM osquery_info;' --json | jq -r '.[0].hostname' 2>/dev/null || echo 'Not enrolled')"
      else
        echo "OSQuery not installed"
      fi
    owner: root
    group: root
    mode: '0755'

- name: Test agent connectivity
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:9090/health"
    method: GET
  register: agent_health
  retries: 5
  delay: 10

- name: Verify agent health
  assert:
    that:
      - agent_health.json.status == 'healthy'
    fail_msg: "Agent health check failed"

- name: Clean up temporary files
  file:
    path: /tmp/maas-agent.tar.gz
    state: absent