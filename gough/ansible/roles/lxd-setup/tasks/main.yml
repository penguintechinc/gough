---
# LXD Setup Role - Main Tasks
# Installs and configures LXD for container and VM workloads

- name: Display LXD setup configuration
  debug:
    msg: |
      === LXD Setup Configuration ===
      LXD Version: {{ lxd_version | default('latest') }}
      Storage Backend: {{ lxd_storage_backend | default('zfs') }}
      Network Bridge: {{ lxd_bridge_name | default('lxdbr0') }}
      Environment: {{ lxd_environment | default('development') }}
      Enable Clustering: {{ lxd_clustering_enabled | default(false) }}
      ===============================

- name: Update package cache
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install LXD prerequisite packages
  apt:
    name: "{{ lxd_prerequisite_packages }}"
    state: present

- name: Install ZFS utilities (for ZFS storage backend)
  apt:
    name: "{{ lxd_zfs_packages }}"
    state: present
  when: lxd_storage_backend == 'zfs'

- name: Install LXD packages
  apt:
    name: "{{ lxd_packages }}"
    state: present

- name: Create LXD group
  group:
    name: lxd
    state: present

- name: Add users to LXD group
  user:
    name: "{{ item }}"
    groups: lxd
    append: true
  loop: "{{ lxd_users | default(['ubuntu', 'gough']) }}"

- name: Check if LXD is already initialized
  command: lxd waitready --timeout=30
  register: lxd_ready_check
  failed_when: false
  changed_when: false

- name: Initialize LXD with preseed configuration
  block:
    - name: Generate LXD preseed configuration
      template:
        src: lxd-preseed.yaml.j2
        dest: /tmp/lxd-preseed.yaml
        mode: '0600'

    - name: Initialize LXD with preseed
      command: lxd init --preseed < /tmp/lxd-preseed.yaml
      register: lxd_init_result
      when: lxd_ready_check.rc != 0

    - name: Remove preseed file
      file:
        path: /tmp/lxd-preseed.yaml
        state: absent

  when: lxd_ready_check.rc != 0

- name: Configure LXD storage pools
  block:
    - name: Create additional storage pools
      command: lxc storage create {{ item.name }} {{ item.driver }} {{ item.config | default('') }}
      register: storage_pool_result
      failed_when:
        - storage_pool_result.rc != 0
        - "'already exists' not in storage_pool_result.stderr"
      changed_when: storage_pool_result.rc == 0
      loop: "{{ lxd_storage_pools | default([]) }}"

- name: Configure LXD network profiles
  block:
    - name: Create custom network bridges
      command: >
        lxc network create {{ item.name }}
        {% for key, value in item.config.items() %}
        {{ key }}={{ value }}
        {% endfor %}
      register: network_create_result
      failed_when:
        - network_create_result.rc != 0
        - "'already exists' not in network_create_result.stderr"
      changed_when: network_create_result.rc == 0
      loop: "{{ lxd_networks | default([]) }}"

- name: Configure LXD profiles
  block:
    - name: Create custom LXD profiles
      shell: |
        cat << 'EOF' | lxc profile edit {{ item.name }}
        {{ item.config | to_nice_yaml }}
        EOF
      loop: "{{ lxd_profiles | default([]) }}"
      register: profile_config_result
      changed_when: true

- name: Configure LXD clustering
  block:
    - name: Enable clustering on first node
      command: >
        lxc cluster enable {{ inventory_hostname }}
        --accept-license=true
      register: cluster_enable_result
      when: 
        - lxd_clustering_enabled | default(false)
        - inventory_hostname == groups['lxd_hosts'][0]

    - name: Get cluster join token
      command: lxc cluster add {{ inventory_hostname }}
      register: cluster_token
      delegate_to: "{{ groups['lxd_hosts'][0] }}"
      when: 
        - lxd_clustering_enabled | default(false)
        - inventory_hostname != groups['lxd_hosts'][0]

    - name: Join LXD cluster
      command: lxc cluster accept {{ cluster_token.stdout }}
      when: 
        - lxd_clustering_enabled | default(false)
        - inventory_hostname != groups['lxd_hosts'][0]
        - cluster_token.stdout is defined

  when: lxd_clustering_enabled | default(false)

- name: Configure LXD remote access
  block:
    - name: Set LXD server address
      command: lxc config set core.https_address {{ ansible_default_ipv4.address }}:{{ lxd_https_port | default(8443) }}
      register: https_config_result
      changed_when: https_config_result.rc == 0

    - name: Set LXD trust password
      command: lxc config set core.trust_password {{ lxd_trust_password }}
      register: trust_config_result
      changed_when: trust_config_result.rc == 0
      no_log: true
      when: lxd_trust_password is defined

    - name: Configure LXD API settings
      command: lxc config set {{ item.key }} {{ item.value }}
      loop: "{{ lxd_api_config | default([]) }}"
      register: api_config_result
      changed_when: api_config_result.rc == 0

- name: Download and configure LXD images
  block:
    - name: Add image servers
      command: lxc remote add {{ item.name }} {{ item.url }} --protocol={{ item.protocol | default('simplestreams') }} --accept-certificate
      register: remote_add_result
      failed_when:
        - remote_add_result.rc != 0
        - "'already exists' not in remote_add_result.stderr"
      changed_when: remote_add_result.rc == 0
      loop: "{{ lxd_image_servers | default([]) }}"

    - name: Download base images
      command: lxc image copy {{ item.source }} local: --alias {{ item.alias }}
      register: image_copy_result
      failed_when:
        - image_copy_result.rc != 0
        - "'already exists' not in image_copy_result.stderr"
      changed_when: image_copy_result.rc == 0
      loop: "{{ lxd_base_images | default([]) }}"

- name: Configure LXD monitoring
  block:
    - name: Create LXD monitoring script
      template:
        src: lxd-monitor.sh.j2
        dest: /usr/local/bin/lxd-monitor.sh
        mode: '0755'

    - name: Create LXD monitoring systemd service
      template:
        src: lxd-monitor.service.j2
        dest: /etc/systemd/system/lxd-monitor.service
        mode: '0644'

    - name: Create LXD monitoring systemd timer
      template:
        src: lxd-monitor.timer.j2
        dest: /etc/systemd/system/lxd-monitor.timer
        mode: '0644'

    - name: Enable LXD monitoring
      systemd:
        name: lxd-monitor.timer
        enabled: true
        state: started
        daemon_reload: true

  when: lxd_monitoring_enabled | default(true)

- name: Configure firewall for LXD
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "LXD"
  loop: "{{ lxd_firewall_ports }}"
  when: lxd_configure_firewall | default(true)

- name: Create LXD management scripts
  block:
    - name: Create container management script
      template:
        src: lxd-container-mgmt.sh.j2
        dest: /usr/local/bin/lxd-container-mgmt.sh
        mode: '0755'

    - name: Create backup script
      template:
        src: lxd-backup.sh.j2
        dest: /usr/local/bin/lxd-backup.sh
        mode: '0755'

    - name: Create cleanup script
      template:
        src: lxd-cleanup.sh.j2
        dest: /usr/local/bin/lxd-cleanup.sh
        mode: '0755'

    - name: Schedule LXD cleanup
      cron:
        name: "lxd-cleanup"
        hour: "3"
        minute: "0"
        weekday: "0"
        job: "/usr/local/bin/lxd-cleanup.sh >> /var/log/lxd-cleanup.log 2>&1"
      when: lxd_auto_cleanup | default(true)

- name: Configure LXD log rotation
  template:
    src: lxd-logrotate.j2
    dest: /etc/logrotate.d/lxd
    mode: '0644'

- name: Create test containers (for verification)
  block:
    - name: Launch test container
      command: >
        lxc launch {{ lxd_test_image | default('ubuntu:22.04') }} test-container-{{ ansible_date_time.epoch }}
        --config limits.cpu=1
        --config limits.memory=512MB
      register: test_container_result
      when: lxd_run_tests | default(true)

    - name: Wait for test container to start
      command: lxc exec test-container-{{ ansible_date_time.epoch }} -- echo "Container ready"
      register: container_ready
      retries: 30
      delay: 2
      when: 
        - lxd_run_tests | default(true)
        - test_container_result.rc == 0

    - name: Delete test container
      command: lxc delete test-container-{{ ansible_date_time.epoch }} --force
      when: 
        - lxd_run_tests | default(true)
        - test_container_result.rc == 0

  when: lxd_run_tests | default(true)

- name: Verify LXD installation
  block:
    - name: Check LXD version
      command: lxd --version
      register: lxd_version_check
      changed_when: false

    - name: Check LXD service status
      command: systemctl is-active snap.lxd.daemon
      register: lxd_service_status
      changed_when: false

    - name: Get LXD status
      command: lxc info
      register: lxd_status
      changed_when: false

    - name: Display LXD verification results
      debug:
        msg: |
          === LXD Installation Verified ===
          Version: {{ lxd_version_check.stdout }}
          Service Status: {{ lxd_service_status.stdout }}
          API Status: {{ 'Online' if 'server online' in lxd_status.stdout.lower() else 'Offline' }}
          Storage Pools: {{ (lxd_status.stdout | regex_findall('storage pools: ([0-9]+)') | first) if 'storage pools:' in lxd_status.stdout else '0' }}
          Networks: {{ (lxd_status.stdout | regex_findall('networks: ([0-9]+)') | first) if 'networks:' in lxd_status.stdout else '0' }}
          =================================

- name: Create LXD setup summary
  copy:
    content: |
      LXD setup completed successfully on {{ inventory_hostname }}
      =====================================================
      
      Installation Details:
      - LXD Version: {{ lxd_version_check.stdout if lxd_version_check is defined else 'Unknown' }}
      - Storage Backend: {{ lxd_storage_backend | default('zfs') }}
      - Network Bridge: {{ lxd_bridge_name | default('lxdbr0') }}
      - HTTPS Port: {{ lxd_https_port | default(8443) }}
      - Clustering: {{ 'Enabled' if lxd_clustering_enabled | default(false) else 'Disabled' }}
      
      Configuration:
      - Storage Pools: {{ lxd_storage_pools | length if lxd_storage_pools is defined else 1 }}
      - Network Bridges: {{ lxd_networks | length if lxd_networks is defined else 1 }}
      - Custom Profiles: {{ lxd_profiles | length if lxd_profiles is defined else 0 }}
      - Monitoring: {{ 'Enabled' if lxd_monitoring_enabled | default(true) else 'Disabled' }}
      - Auto Cleanup: {{ 'Enabled' if lxd_auto_cleanup | default(true) else 'Disabled' }}
      
      Setup completed: {{ ansible_date_time.iso8601 }}
      =====================================================
    dest: "/var/log/lxd-setup-{{ ansible_date_time.epoch }}.log"
    mode: '0644'