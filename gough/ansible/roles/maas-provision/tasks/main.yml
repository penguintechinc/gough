---
# MaaS Provision Role - Main Tasks
# Handles interaction with MaaS API for machine provisioning

- name: Validate MaaS provisioning parameters
  assert:
    that:
      - maas_url is defined
      - maas_oauth_token is defined
      - machine_count is defined
      - machine_count | int > 0
      - machine_count | int <= 100
    fail_msg: "Required MaaS provisioning parameters are missing or invalid"

- name: Display provisioning parameters
  debug:
    msg: |
      === MaaS Provisioning Parameters ===
      MaaS URL: {{ maas_url }}
      Machine Count: {{ machine_count }}
      Machine Role: {{ machine_role | default('general') }}
      Environment: {{ environment | default('development') }}
      Architecture: {{ architecture | default('amd64') }}
      ===================================

- name: Test MaaS API connectivity
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/version/"
    method: GET
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
    timeout: 30
  register: maas_api_test
  retries: 3
  delay: 5

- name: Get MaaS API version info
  debug:
    msg: "Connected to MaaS API version {{ maas_api_test.json.version }}"

- name: Retrieve available machines from MaaS
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/"
    method: GET
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
  register: maas_machines

- name: Filter machines by status and criteria
  set_fact:
    available_machines: "{{ maas_machines.json | selectattr('status_name', 'equalto', 'Ready') | 
                          selectattr('architecture', 'search', architecture | default('amd64')) | 
                          list }}"

- name: Check available machine count
  assert:
    that:
      - available_machines | length >= machine_count | int
    fail_msg: |
      Insufficient machines available: {{ available_machines | length }} available, {{ machine_count }} requested.
      Available machines: {{ available_machines | map(attribute='hostname') | list | join(', ') }}

- name: Select machines for provisioning
  set_fact:
    selected_machines: "{{ available_machines[:machine_count | int] }}"

- name: Display selected machines
  debug:
    msg: |
      Selected machines for provisioning:
      {% for machine in selected_machines %}
      - {{ machine.hostname }} ({{ machine.system_id }}) - {{ machine.cpu_count }} CPU, {{ machine.memory }} MB RAM
      {% endfor %}

- name: Commission selected machines
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/{{ item.system_id }}/"
    method: POST
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
    body_format: form-urlencoded
    body:
      op: commission
      commissioning_scripts: "{{ commissioning_scripts | default('update_firmware,internet-connectivity') }}"
      testing_scripts: "{{ testing_scripts | default('smartctl-validate,7z') }}"
    status_code: [200, 202, 409]  # 409 if already commissioning/commissioned
  loop: "{{ selected_machines }}"
  register: commission_results
  when: item.status_name == 'Ready'

- name: Wait for commissioning to complete
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/{{ item.item.system_id }}/"
    method: GET
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
  loop: "{{ commission_results.results | default([]) }}"
  register: commission_status
  until: commission_status.json.status_name in ['Ready', 'Failed testing', 'Failed commissioning']
  retries: "{{ commissioning_timeout_minutes | default(30) }}"
  delay: 30
  when: 
    - item.status is defined
    - item.status not in [409]  # Skip already commissioned machines

- name: Verify commissioning success
  fail:
    msg: "Machine {{ item.json.hostname }} failed commissioning with status {{ item.json.status_name }}"
  loop: "{{ commission_status.results | default([]) }}"
  when: 
    - item.json is defined
    - item.json.status_name in ['Failed testing', 'Failed commissioning']

- name: Tag machines with metadata
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/{{ item.system_id }}/"
    method: POST
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
    body_format: form-urlencoded
    body:
      op: set_tags
      tags: |
        managed-by-gough,
        role-{{ machine_role | default('general') }},
        env-{{ environment | default('development') }},
        provisioned-{{ ansible_date_time.epoch }}
  loop: "{{ selected_machines }}"
  register: tag_results

- name: Allocate machines for deployment
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/"
    method: POST
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
    body_format: form-urlencoded
    body:
      op: allocate
      system_id: "{{ item.system_id }}"
      comment: "Allocated by Gough for {{ machine_role | default('general') }} role in {{ environment | default('development') }} environment"
      tags: "role-{{ machine_role | default('general') }}"
  loop: "{{ selected_machines }}"
  register: allocate_results

- name: Prepare cloud-init user data
  set_fact:
    cloud_init_data: "{{ lookup('file', cloud_init_template_path + '/' + cloud_init_template) | b64encode }}"
  when: 
    - cloud_init_template is defined
    - cloud_init_template_path is defined

- name: Deploy allocated machines with Ubuntu 24.04 LTS
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/{{ item.json.system_id }}/"
    method: POST
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
    body_format: form-urlencoded
    body:
      op: deploy
      distro_series: "{{ ubuntu_series | default('jammy') }}"  # Ubuntu 22.04 LTS (24.04 when available)
      hwe_kernel: "{{ hwe_kernel | default('hwe-22.04') }}"
      user_data: "{{ cloud_init_data | default('') }}"
      comment: "Deployed by Gough orchestration - {{ ansible_date_time.iso8601 }}"
  loop: "{{ allocate_results.results }}"
  register: deploy_results
  when: item.json is defined

- name: Wait for deployment completion
  uri:
    url: "{{ maas_url }}/api/{{ maas_api_version | default('2.0') }}/machines/{{ item.item.json.system_id }}/"
    method: GET
    headers:
      Authorization: "OAuth {{ maas_oauth_token }}"
  loop: "{{ deploy_results.results | default([]) }}"
  register: deployment_status
  until: deployment_status.json.status_name in ['Deployed', 'Failed deployment']
  retries: "{{ deployment_timeout_minutes | default(45) }}"
  delay: 60
  when: 
    - item.json is defined
    - item.item.json is defined

- name: Verify deployment success
  fail:
    msg: "Machine {{ item.json.hostname }} failed deployment with status {{ item.json.status_name }}"
  loop: "{{ deployment_status.results | default([]) }}"
  when: 
    - item.json is defined
    - item.json.status_name == 'Failed deployment'

- name: Collect successfully deployed machines
  set_fact:
    deployed_machines: "{{ deployment_status.results | 
                          selectattr('json', 'defined') | 
                          selectattr('json.status_name', 'equalto', 'Deployed') | 
                          map(attribute='json') | 
                          list }}"

- name: Display deployment results
  debug:
    msg: |
      === Deployment Results ===
      Successfully deployed: {{ deployed_machines | length }} machines
      {% for machine in deployed_machines %}
      - {{ machine.hostname }} ({{ machine.system_id }})
        IP: {{ machine.ip_addresses[0] if machine.ip_addresses else 'Pending DHCP' }}
        CPU: {{ machine.cpu_count }} cores
        RAM: {{ machine.memory }} MB
        Storage: {{ machine.storage | default(0) }} GB
      {% endfor %}
      =========================

- name: Generate provisioning report
  template:
    src: provisioning-report.j2
    dest: "{{ provisioning_report_path | default('/tmp') }}/maas-provisioning-{{ ansible_date_time.epoch }}.json"
  vars:
    provisioning_data:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      machine_count: "{{ machine_count }}"
      machine_role: "{{ machine_role | default('general') }}"
      environment: "{{ environment | default('development') }}"
      deployed_machines: "{{ deployed_machines }}"
      maas_version: "{{ maas_api_test.json.version }}"

- name: Return deployment information
  set_fact:
    maas_provision_result:
      success: true
      deployed_count: "{{ deployed_machines | length }}"
      deployed_machines: "{{ deployed_machines }}"
      deployment_timestamp: "{{ ansible_date_time.iso8601 }}"