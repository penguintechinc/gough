---
# OSQuery and FleetDM Agent Deployment Playbook
# Installs and configures OSQuery agents on deployed servers

- name: Deploy OSQuery Agents for FleetDM
  hosts: deployed_servers
  gather_facts: true
  become: true
  vars:
    fleetdm_url: "{{ hostvars['localhost']['fleetdm_url'] | default('https://fleetdm:8443') }}"
    osquery_version: "{{ hostvars['localhost']['osquery_version'] | default('5.10.2') }}"
    enroll_secret: "{{ hostvars['localhost']['fleet_enroll_secret'] }}"
    
  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - fleetdm_url is defined
          - enroll_secret is defined
        fail_msg: "Required variables missing: fleetdm_url, enroll_secret"

    - name: Check if this is Ubuntu/Debian
      assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: "This playbook is designed for Ubuntu/Debian systems only"

  tasks:
    - name: Update package cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - gnupg
          - software-properties-common
          - ca-certificates
          - apt-transport-https
        state: present

    - name: Create osquery directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - /etc/osquery
        - /etc/osquery/certs
        - /var/osquery
        - /var/log/osquery
        - /opt/osquery

    - name: Download OSQuery package
      get_url:
        url: "https://pkg.osquery.io/deb/osquery_{{ osquery_version }}-1.linux_amd64.deb"
        dest: "/tmp/osquery_{{ osquery_version }}.deb"
        mode: '0644'
      register: osquery_download

    - name: Install OSQuery
      apt:
        deb: "/tmp/osquery_{{ osquery_version }}.deb"
        state: present
      when: osquery_download is succeeded

    - name: Clean up downloaded package
      file:
        path: "/tmp/osquery_{{ osquery_version }}.deb"
        state: absent

    - name: Download FleetDM certificate
      get_url:
        url: "{{ fleetdm_url }}/api/v1/fleet/certificate"
        dest: /etc/osquery/certs/server.crt
        mode: '0644'
        validate_certs: false
      ignore_errors: true  # Certificate might not be available yet

    - name: Create self-signed certificate if download failed
      command: |
        openssl s_client -connect {{ fleetdm_url | regex_replace('https?://') }}:8443 -showcerts < /dev/null 2>/dev/null | 
        openssl x509 -outform PEM > /etc/osquery/certs/server.crt
      args:
        creates: /etc/osquery/certs/server.crt
      ignore_errors: true

    - name: Create enrollment secret file
      copy:
        content: "{{ enroll_secret }}"
        dest: /etc/osquery/enroll_secret
        mode: '0600'
        owner: root
        group: root

    - name: Create OSQuery flags configuration
      copy:
        content: |
          # OSQuery Configuration Flags for FleetDM Integration
          # Generated by Gough Hypervisor Automation System
          
          # Fleet server configuration
          --tls_hostname={{ fleetdm_url | regex_replace('https?://') }}
          --tls_server_certs=/etc/osquery/certs/
          --enroll_tls_endpoint=/api/v1/osquery/enroll
          --config_plugin=tls
          --config_tls_endpoint=/api/v1/osquery/config
          --config_tls_refresh=10
          
          # Logging configuration
          --logger_plugin=tls
          --logger_tls_endpoint=/api/v1/osquery/log
          --logger_tls_period=10
          --disable_logging=false
          
          # Host identification
          --host_identifier=uuid
          --enroll_secret_path=/etc/osquery/enroll_secret
          
          # Enrollment configuration
          --disable_enrollment=false
          --enroll_cooldown=60
          
          # Query scheduling
          --schedule_splay_percent=10
          --schedule_default_interval=3600
          
          # Carving configuration
          --disable_carver=false
          --carver_start_endpoint=/api/v1/osquery/carve/begin
          --carver_continue_endpoint=/api/v1/osquery/carve/block
          --carver_block_size=8000000
          
          # Performance settings
          --events_max=50000
          --events_expiry=86400
          --database_path=/var/osquery/osquery.db
          --pidfile=/var/osquery/osquery.pidfile
          
          # Security settings
          --disable_audit=false
          --audit_allow_config=true
          --audit_allow_sockets=true
          
          # Verbose logging
          --verbose=false
          --alsologtostderr=false
          
          # Distributed queries
          --disable_distributed=false
          --distributed_plugin=tls
          --distributed_interval=60
          --distributed_tls_max_attempts=3
          
          # Extensions
          --extensions_socket=/var/osquery/osquery.em
          --extensions_timeout=3
          
          # Pack refresh
          --pack_refresh_interval=3600
          
          # Resource limits
          --watchdog_memory_limit=150
          --watchdog_utilization_limit=20
          
          # TLS settings
          --tls_dump=false
          --enroll_tls_max_attempts=3
          --config_tls_max_attempts=3
          --logger_tls_max_attempts=3
        dest: /etc/osquery/osquery.flags
        mode: '0644'
        owner: root
        group: root

    - name: Create OSQuery configuration file
      copy:
        content: |
          {
            "options": {
              "config_plugin": "tls",
              "logger_plugin": "tls",
              "host_identifier": "uuid",
              "schedule_splay_percent": 10
            },
            "schedule": {
              "system_info": {
                "query": "SELECT hostname, cpu_brand, physical_memory FROM system_info;",
                "interval": 3600
              }
            },
            "decorators": {
              "load": [
                "SELECT uuid AS host_uuid FROM system_info;",
                "SELECT hostname FROM system_info;"
              ]
            }
          }
        dest: /etc/osquery/osquery.conf
        mode: '0644'
        owner: root
        group: root

    - name: Create OSQuery systemd service
      copy:
        content: |
          [Unit]
          Description=The osquery Endpoint Detection and Response Agent
          Documentation=https://osquery.io/docs/
          After=network.target syslog.service
          
          [Service]
          Type=notify
          ExecStart=/usr/bin/osqueryd --flagfile=/etc/osquery/osquery.flags --config_path=/etc/osquery/osquery.conf
          ExecReload=/bin/kill -SIGUSR1 $MAINPID
          Restart=always
          RestartSec=3
          TimeoutStartSec=60
          TimeoutStopSec=60
          User=root
          Group=root
          
          # Security settings
          NoNewPrivileges=yes
          PrivateTmp=yes
          ProtectSystem=strict
          ReadWritePaths=/var/osquery /var/log/osquery /etc/osquery
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/osquery.service
        mode: '0644'

    - name: Create osquery user and group
      group:
        name: osquery
        state: present

    - name: Create osquery user
      user:
        name: osquery
        group: osquery
        system: true
        shell: /bin/false
        home: /var/osquery
        create_home: false
        state: present

    - name: Set ownership of osquery directories
      file:
        path: "{{ item }}"
        owner: osquery
        group: osquery
        recurse: true
      loop:
        - /var/osquery
        - /var/log/osquery

    - name: Reload systemd daemon
      systemd:
        daemon_reload: true

    - name: Enable and start osquery service
      systemd:
        name: osquery
        enabled: true
        state: started

    - name: Wait for osquery to start
      wait_for:
        timeout: 30
      ignore_errors: true

    - name: Check osquery service status
      systemd:
        name: osquery
      register: osquery_status

    - name: Display osquery status
      debug:
        msg: |
          OSQuery service status: {{ osquery_status.status.ActiveState }}
          FleetDM URL: {{ fleetdm_url }}
          Enrollment configured with secret file

    - name: Create osquery health check script
      copy:
        content: |
          #!/bin/bash
          # OSQuery health check script for Gough Hypervisor
          
          set -e
          
          echo "OSQuery Health Check Report"
          echo "=========================="
          echo "Date: $(date)"
          echo "Host: $(hostname)"
          echo ""
          
          # Check service status
          echo "Service Status:"
          systemctl is-active osquery || echo "OSQuery service is not active"
          systemctl is-enabled osquery || echo "OSQuery service is not enabled"
          echo ""
          
          # Check process
          echo "Process Information:"
          ps aux | grep osquery | grep -v grep || echo "No OSQuery processes found"
          echo ""
          
          # Check log files
          echo "Recent Log Entries:"
          if [ -f /var/log/osquery/osqueryd.results.log ]; then
              echo "Results log (last 5 lines):"
              tail -5 /var/log/osquery/osqueryd.results.log
          else
              echo "Results log not found"
          fi
          echo ""
          
          if [ -f /var/log/osquery/osqueryd.INFO ]; then
              echo "Info log (last 5 lines):"
              tail -5 /var/log/osquery/osqueryd.INFO
          else
              echo "Info log not found"
          fi
          echo ""
          
          # Test simple query
          echo "Test Query:"
          osqueryi --config_path=/etc/osquery/osquery.conf "SELECT version FROM osquery_info;" || echo "Query test failed"
          
          echo "Health check completed."
        dest: /usr/local/bin/osquery-health-check
        mode: '0755'
        owner: root
        group: root

    - name: Run initial health check
      command: /usr/local/bin/osquery-health-check
      register: health_check
      ignore_errors: true

    - name: Display health check results
      debug:
        msg: "{{ health_check.stdout }}"
      when: health_check.stdout is defined

  handlers:
    - name: restart osquery
      systemd:
        name: osquery
        state: restarted

- name: Verify Fleet Enrollment
  hosts: deployed_servers
  gather_facts: false
  become: true
  tasks:
    - name: Wait for enrollment to complete
      wait_for:
        timeout: 60
      
    - name: Check enrollment status in logs
      shell: |
        if [ -f /var/log/osquery/osqueryd.INFO ]; then
          grep -i "enroll" /var/log/osquery/osqueryd.INFO | tail -5 || echo "No enrollment logs found"
        else
          echo "OSQuery info log not available"
        fi
      register: enrollment_check
      ignore_errors: true

    - name: Display enrollment status
      debug:
        msg: |
          Enrollment Status Check:
          {{ enrollment_check.stdout }}
      when: enrollment_check.stdout is defined