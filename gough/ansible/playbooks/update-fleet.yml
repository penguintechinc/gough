---
# Fleet Configuration Update Playbook
# Updates FleetDM configuration and manages OSQuery deployments

- name: Update Fleet Management Configuration
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    fleet_environment: "{{ fleet_environment | default(server_environment | default('development')) }}"
    fleet_role: "{{ fleet_role | default(server_role | default('general_server')) }}"
    fleet_api_url: "{{ fleet_url | default('https://fleetdm:8443') }}"
    
  pre_tasks:
    - name: Display fleet update plan
      debug:
        msg: |
          === Fleet Configuration Update ===
          Environment: {{ fleet_environment }}
          Role: {{ fleet_role }}
          Fleet URL: {{ fleet_api_url }}
          Target Servers: {{ groups['deployed_servers'] | default([]) | length }}
          =================================

    - name: Verify Fleet API connectivity
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/version"
        method: GET
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        validate_certs: false
        timeout: 30
      register: fleet_version
      retries: 3
      delay: 10

    - name: Display Fleet version
      debug:
        msg: "Connected to Fleet {{ fleet_version.json.version }}"

  tasks:
    # Configure Fleet teams and users
    - name: Create environment-specific Fleet team
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/teams"
        method: POST
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          name: "{{ fleet_environment }}-{{ fleet_role }}"
          description: "Team for {{ fleet_role }} servers in {{ fleet_environment }}"
        validate_certs: false
        status_code: [200, 409]  # 409 if team already exists
      register: fleet_team

    - name: Get Fleet team ID
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/teams"
        method: GET
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        validate_certs: false
      register: fleet_teams

    - name: Set team ID
      set_fact:
        team_id: "{{ fleet_teams.json.teams | selectattr('name', 'equalto', fleet_environment + '-' + fleet_role) | map(attribute='id') | first | default('') }}"

    # Update Fleet configuration
    - name: Update Fleet app configuration
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/config"
        method: PATCH
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          org_info:
            org_name: "Gough Hypervisor - {{ fleet_environment | title }}"
            org_logo_url: "{{ org_logo_url | default('') }}"
          server_settings:
            server_url: "{{ fleet_api_url }}"
            live_query_disabled: false
            enable_analytics: false
          smtp_settings:
            enable_smtp: "{{ enable_smtp | default(false) }}"
            server: "{{ smtp_server | default('') }}"
            port: "{{ smtp_port | default(587) }}"
            authentication_type: "{{ smtp_auth | default('authtype_username_password') }}"
            username_or_email: "{{ smtp_username | default('') }}"
            password: "{{ smtp_password | default('') }}"
            sender_address: "{{ smtp_sender | default('') }}"
          sso_settings:
            enable_sso: false
        validate_certs: false

    # Create and update query packs
    - name: Create monitoring query pack
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/packs"
        method: POST
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          name: "gough-monitoring-{{ fleet_role }}"
          description: "Gough monitoring queries for {{ fleet_role }} servers"
          platform: "linux"
          disabled: false
        validate_certs: false
        status_code: [200, 409]
      register: monitoring_pack

    - name: Get monitoring pack ID
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/packs"
        method: GET
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        validate_certs: false
      register: fleet_packs

    - name: Set monitoring pack ID
      set_fact:
        monitoring_pack_id: "{{ fleet_packs.json.packs | selectattr('name', 'equalto', 'gough-monitoring-' + fleet_role) | map(attribute='id') | first | default('') }}"

    # Add role-specific queries to the pack
    - name: Add base system monitoring queries
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/packs/{{ monitoring_pack_id }}/scheduled"
        method: POST
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          name: "{{ item.name }}"
          query: "{{ item.query }}"
          interval: "{{ item.interval }}"
          platform: "linux"
          version: ">=4.0.0"
          snapshot: "{{ item.snapshot | default(false) }}"
          removed: "{{ item.removed | default(true) }}"
          shard: "{{ item.shard | default(100) }}"
        validate_certs: false
        status_code: [200, 409]
      loop: "{{ base_monitoring_queries }}"
      vars:
        base_monitoring_queries:
          - name: "system_info"
            query: "SELECT hostname, cpu_brand, physical_memory, hardware_vendor, hardware_model FROM system_info;"
            interval: 3600
          - name: "uptime"
            query: "SELECT total_seconds FROM uptime;"
            interval: 600
          - name: "memory_usage"
            query: "SELECT memory_total, memory_free, memory_available, memory_percent FROM memory_info;"
            interval: 300
          - name: "disk_usage"
            query: "SELECT device, path, size, used, available, (used*100/size) as percent_used FROM mounts WHERE path IN ('/', '/home', '/var');"
            interval: 600
          - name: "network_interfaces"
            query: "SELECT interface, mac, ip, mask, type FROM interface_addresses WHERE interface NOT LIKE 'lo%';"
            interval: 1800
          - name: "listening_ports"
            query: "SELECT DISTINCT process.name, listening_ports.port, listening_ports.protocol, process.pid FROM listening_ports LEFT JOIN processes AS process ON listening_ports.pid = process.pid;"
            interval: 600
          - name: "running_processes"
            query: "SELECT name, pid, parent, cmdline, cwd, root, uid, gid FROM processes WHERE pid > 1;"
            interval: 300
            snapshot: true
          - name: "user_logins"
            query: "SELECT username, type, time, host FROM last;"
            interval: 300
          - name: "failed_logins"
            query: "SELECT username, time, host FROM last WHERE username = '' OR username IS NULL;"
            interval: 300
          - name: "crontab"
            query: "SELECT command, path, minute, hour, day_of_month, month, day_of_week FROM crontab;"
            interval: 3600

    # Add Docker-specific queries for Docker hosts
    - name: Add Docker monitoring queries
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/packs/{{ monitoring_pack_id }}/scheduled"
        method: POST
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          name: "{{ item.name }}"
          query: "{{ item.query }}"
          interval: "{{ item.interval }}"
          platform: "linux"
          version: ">=4.0.0"
          snapshot: "{{ item.snapshot | default(false) }}"
          removed: "{{ item.removed | default(true) }}"
          shard: "{{ item.shard | default(100) }}"
        validate_certs: false
        status_code: [200, 409]
      loop: "{{ docker_monitoring_queries }}"
      when: fleet_role == 'docker_host'
      vars:
        docker_monitoring_queries:
          - name: "docker_containers"
            query: "SELECT id, name, image, image_id, command, created, state, status FROM docker_containers;"
            interval: 300
          - name: "docker_images"
            query: "SELECT id, repository, tag, created, size_bytes, virtual_size FROM docker_images;"
            interval: 600
          - name: "docker_networks"
            query: "SELECT id, name, driver, created FROM docker_networks;"
            interval: 1800
          - name: "docker_volumes"
            query: "SELECT name, driver, mount_point FROM docker_volumes;"
            interval: 1800

    # Create enrollment secret for the environment
    - name: Create enrollment secret
      uri:
        url: "{{ fleet_api_url }}/api/v1/fleet/spec/enroll_secret"
        method: POST
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        body_format: json
        body:
          spec:
            secrets:
              - secret: "{{ fleet_environment }}-{{ fleet_role }}-{{ ansible_date_time.epoch | string | hash('sha256') | truncate(32, True, '') }}"
                description: "Enrollment secret for {{ fleet_environment }} {{ fleet_role }} servers"
        validate_certs: false
      register: enrollment_secret

    # Create Fleet configuration for servers
    - name: Generate Fleet agent configuration
      set_fact:
        fleet_config:
          server_url: "{{ fleet_api_url }}"
          enrollment_secret: "{{ enrollment_secret.json.spec.secrets[0].secret if enrollment_secret.json is defined else '' }}"
          team_id: "{{ team_id }}"
          logging:
            filesystem_path: "/var/log/osquery/"
            enable_log_rotation: true
            enable_log_compression: true
          options:
            pack_delimiter: "/"
            logger_snapshot_event_type: true
            schedule_splay_percent: 10
            events_expiry: 3600
            verbose: "{{ 'true' if fleet_environment == 'development' else 'false' }}"
            worker_threads: 2
            enable_monitor: true
            config_refresh: 600
            decorators:
              load:
                - "SELECT uuid AS host_uuid FROM system_info;"
                - "SELECT user AS username FROM logged_in_users ORDER BY time DESC LIMIT 1;"

    # Apply configuration to deployed servers
    - name: Apply Fleet configuration to servers
      include_role:
        name: osquery-install
      vars:
        osquery_config: "{{ fleet_config }}"
        server_environment: "{{ fleet_environment }}"
        server_role: "{{ fleet_role }}"

# Update OSQuery agents on deployed servers
- name: Update OSQuery Agents
  hosts: deployed_servers
  become: true
  gather_facts: true
  serial: 20
  vars:
    fleet_environment: "{{ fleet_environment | default('development') }}"
    fleet_role: "{{ fleet_role | default('general_server') }}"
    
  tasks:
    - name: Check if OSQuery is installed
      stat:
        path: /usr/bin/osqueryd
      register: osquery_installed

    - name: Install/Update OSQuery
      include_role:
        name: osquery-install
      when: not osquery_installed.stat.exists or force_osquery_update | default(false)

    - name: Update OSQuery configuration
      template:
        src: templates/osquery.conf.j2
        dest: /etc/osquery/osquery.conf
        owner: root
        group: root
        mode: '0644'
        backup: true
      notify: restart osqueryd

    - name: Update OSQuery flags
      template:
        src: templates/osquery.flags.j2
        dest: /etc/osquery/osquery.flags
        owner: root
        group: root
        mode: '0644'
        backup: true
      notify: restart osqueryd

    - name: Update enrollment secret
      copy:
        content: "{{ hostvars['localhost']['fleet_config']['enrollment_secret'] }}"
        dest: /etc/osquery/enroll_secret
        owner: root
        group: root
        mode: '0600'
      notify: restart osqueryd
      when: hostvars['localhost']['fleet_config']['enrollment_secret'] != ''

    - name: Ensure OSQuery service is running
      systemd:
        name: osqueryd
        state: started
        enabled: true
        daemon_reload: true

    - name: Verify OSQuery enrollment with Fleet
      uri:
        url: "{{ fleet_url }}/api/v1/fleet/hosts"
        method: GET
        headers:
          Authorization: "Bearer {{ fleet_api_token }}"
        validate_certs: false
      delegate_to: localhost
      register: fleet_hosts
      retries: 5
      delay: 30

    - name: Check host enrollment status
      set_fact:
        host_enrolled: "{{ fleet_hosts.json.hosts | selectattr('hostname', 'equalto', inventory_hostname) | list | length > 0 }}"
      delegate_to: localhost

    - name: Report enrollment status
      debug:
        msg: |
          === OSQuery Enrollment Status ===
          Host: {{ inventory_hostname }}
          Enrolled: {{ host_enrolled }}
          Fleet Environment: {{ fleet_environment }}
          Fleet Role: {{ fleet_role }}
          ================================

  handlers:
    - name: restart osqueryd
      systemd:
        name: osqueryd
        state: restarted
        daemon_reload: true

  post_tasks:
    - name: Update server fleet status
      uri:
        url: "{{ management_server_url }}/api/servers/{{ inventory_hostname }}/fleet"
        method: PUT
        body_format: json
        body:
          hostname: "{{ inventory_hostname }}"
          fleet_enrolled: "{{ host_enrolled }}"
          fleet_environment: "{{ fleet_environment }}"
          fleet_role: "{{ fleet_role }}"
          osquery_version: "{{ ansible_facts.packages.osquery[0].version if 'osquery' in ansible_facts.packages else 'unknown' }}"
          last_update: "{{ ansible_date_time.iso8601 }}"
        headers:
          Authorization: "Bearer {{ management_api_token }}"
      when: management_server_url is defined
      ignore_errors: true

# Generate Fleet update report
- name: Generate Fleet Update Report
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: Collect Fleet update results
      set_fact:
        enrolled_hosts: "{{ groups['deployed_servers'] | length }}"  # Would be calculated from actual results
        total_hosts: "{{ groups['deployed_servers'] | length }}"

    - name: Create Fleet update report
      template:
        src: templates/fleet-update-report.j2
        dest: "/tmp/gough-fleet-update-{{ ansible_date_time.epoch }}.html"
      vars:
        fleet_stats:
          total_hosts: "{{ total_hosts }}"
          enrolled_hosts: "{{ enrolled_hosts }}"
          environment: "{{ fleet_environment }}"
          role: "{{ fleet_role }}"
          update_time: "{{ ansible_date_time.iso8601 }}"

    - name: Display Fleet update summary
      debug:
        msg: |
          === Fleet Update Summary ===
          Total Hosts: {{ total_hosts }}
          Enrolled Hosts: {{ enrolled_hosts }}
          Environment: {{ fleet_environment }}
          Role: {{ fleet_role }}
          Report: /tmp/gough-fleet-update-{{ ansible_date_time.epoch }}.html
          ===========================