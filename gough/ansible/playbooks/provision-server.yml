---
# Server Provisioning Playbook via MaaS API
# Handles bare metal server provisioning, commissioning, and deployment

- name: MaaS Server Provisioning
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    provision_count: "{{ provision_count | default(1) | int }}"
    provision_role: "{{ provision_role | default('general_server') }}"
    provision_environment: "{{ provision_environment | default('development') }}"
    cloud_init_template: "{{ cloud_init_template | default(provision_role + '.yaml') }}"
    timeout_minutes: 30
    
  tasks:
    - name: Validate provisioning parameters
      assert:
        that:
          - provision_count >= 1 and provision_count <= 100
          - provision_role in ['docker_host', 'kubernetes_node', 'general_server']
          - provision_environment in ['development', 'staging', 'production']
        fail_msg: "Invalid provisioning parameters"

    - name: Display provisioning plan
      debug:
        msg: |
          === Server Provisioning Plan ===
          Count: {{ provision_count }}
          Role: {{ provision_role }}
          Environment: {{ provision_environment }}
          Template: {{ cloud_init_template }}
          ===============================

    - name: Check MaaS API connectivity
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/version/"
        method: GET
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        status_code: 200
      register: maas_version
      retries: 3
      delay: 5

    - name: Display MaaS version
      debug:
        msg: "Connected to MaaS {{ maas_version.json.version }}"

    - name: Get available machines from MaaS
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/"
        method: GET
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        status_code: 200
      register: available_machines

    - name: Filter ready machines
      set_fact:
        ready_machines: "{{ available_machines.json | selectattr('status_name', 'equalto', 'Ready') | list }}"

    - name: Validate sufficient machines available
      assert:
        that:
          - ready_machines | length >= provision_count
        fail_msg: "Insufficient ready machines ({{ ready_machines | length }}) for requested count ({{ provision_count }})"

    - name: Select machines for provisioning
      set_fact:
        selected_machines: "{{ ready_machines[:provision_count] }}"

    - name: Generate cloud-init configuration
      include_role:
        name: cloud-init-config
      vars:
        cloud_init_role: "{{ provision_role }}"
        cloud_init_env: "{{ provision_environment }}"
        target_machine: "{{ item }}"
      loop: "{{ selected_machines }}"
      register: cloud_init_configs

    - name: Commission selected machines
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/{{ item.system_id }}/"
        method: POST
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        body_format: form-urlencoded
        body:
          op: commission
          commissioning_scripts: "{{ commissioning_scripts | default('update_firmware,internet-connectivity') }}"
          testing_scripts: "{{ testing_scripts | default('smartctl-validate,7z,fio') }}"
        status_code: [200, 202, 409]  # 409 if already commissioning
      loop: "{{ selected_machines }}"
      register: commission_results
      when: item.status_name == 'Ready'

    - name: Wait for commissioning to complete
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/{{ item.item.system_id }}/"
        method: GET
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
      loop: "{{ commission_results.results }}"
      register: commission_status
      until: commission_status.json.status_name in ['Ready', 'Failed testing']
      retries: "{{ timeout_minutes * 2 }}"  # 30 second intervals
      delay: 30
      when: item.status != 409  # Skip if was already commissioning

    - name: Verify commissioning success
      assert:
        that:
          - item.json.status_name != 'Failed testing'
        fail_msg: "Machine {{ item.json.hostname }} failed commissioning"
      loop: "{{ commission_status.results }}"
      when: commission_status.results is defined

    - name: Tag machines with role and environment
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/{{ item.system_id }}/"
        method: POST
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        body_format: form-urlencoded
        body:
          op: set_tags
          tags: "role-{{ provision_role }},env-{{ provision_environment }},managed-by-gough"
      loop: "{{ selected_machines }}"
      register: tag_results

    - name: Allocate machines for deployment
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/"
        method: POST
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        body_format: form-urlencoded
        body:
          op: allocate
          system_id: "{{ item.system_id }}"
          comment: "Allocated by Gough for {{ provision_role }} in {{ provision_environment }}"
      loop: "{{ selected_machines }}"
      register: allocate_results

    - name: Deploy allocated machines
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/{{ item.json.system_id }}/"
        method: POST
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
        body_format: form-urlencoded
        body:
          op: deploy
          distro_series: "{{ ubuntu_series | default('jammy') }}"  # Ubuntu 24.04 LTS
          hwe_kernel: "{{ hwe_kernel | default('hwe-22.04') }}"
          user_data: "{{ lookup('file', cloud_init_template_path + '/' + cloud_init_template) | b64encode }}"
          comment: "Deployed by Gough orchestration"
      loop: "{{ allocate_results.results }}"
      register: deploy_results
      when: item.json is defined

    - name: Create deployment tracking file
      copy:
        content: |
          # Gough Deployment Tracking
          # Generated: {{ ansible_date_time.iso8601 }}
          
          DEPLOYMENT_ID="{{ ansible_date_time.epoch }}"
          PROVISION_ROLE="{{ provision_role }}"
          PROVISION_ENVIRONMENT="{{ provision_environment }}"
          MACHINE_COUNT="{{ provision_count }}"
          
          # Machine Details
          {% for result in deploy_results.results %}
          MACHINE_{{ loop.index0 }}_ID="{{ result.item.json.system_id }}"
          MACHINE_{{ loop.index0 }}_HOSTNAME="{{ result.item.json.hostname }}"
          MACHINE_{{ loop.index0 }}_STATUS="{{ result.json.status_name if result.json is defined else 'unknown' }}"
          {% endfor %}
        dest: "/tmp/gough-deployment-{{ ansible_date_time.epoch }}.env"
      register: tracking_file

    - name: Wait for deployment completion
      uri:
        url: "{{ maas_url }}/api/{{ maas_api_version }}/machines/{{ item.item.json.system_id }}/"
        method: GET
        headers:
          Authorization: "OAuth {{ maas_oauth_token }}"
      loop: "{{ deploy_results.results }}"
      register: deploy_status
      until: deploy_status.json.status_name in ['Deployed', 'Failed deployment']
      retries: "{{ timeout_minutes * 2 }}"
      delay: 30
      when: item.json is defined

    - name: Verify deployment success
      assert:
        that:
          - item.json.status_name == 'Deployed'
        fail_msg: "Machine {{ item.json.hostname }} failed deployment"
      loop: "{{ deploy_status.results }}"
      when: deploy_status.results is defined

    - name: Collect deployed machine information
      set_fact:
        deployed_machines: "{{ deploy_status.results | selectattr('json.status_name', 'equalto', 'Deployed') | map(attribute='json') | list }}"

    - name: Add deployed machines to inventory
      add_host:
        hostname: "{{ item.hostname }}"
        ansible_host: "{{ item.ip_addresses[0] if item.ip_addresses else item.hostname }}"
        ansible_user: ubuntu
        ansible_ssh_private_key_file: "{{ ssh_private_key_path | default('~/.ssh/id_rsa') }}"
        server_role: "{{ provision_role }}"
        server_environment: "{{ provision_environment }}"
        maas_system_id: "{{ item.system_id }}"
        groups: 
          - deployed_servers
          - "{{ provision_role }}_servers"
      loop: "{{ deployed_machines }}"

    - name: Wait for SSH connectivity
      wait_for:
        host: "{{ item.ip_addresses[0] if item.ip_addresses else item.hostname }}"
        port: 22
        timeout: 300
        delay: 10
      loop: "{{ deployed_machines }}"

    - name: Test SSH connectivity
      ping:
      delegate_to: "{{ item.hostname }}"
      loop: "{{ deployed_machines }}"
      register: ssh_test
      retries: 5
      delay: 30

    - name: Update management server with deployment status
      uri:
        url: "{{ management_server_url }}/api/deployments"
        method: POST
        body_format: json
        body:
          deployment_id: "{{ ansible_date_time.epoch }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          environment: "{{ provision_environment }}"
          role: "{{ provision_role }}"
          machine_count: "{{ deployed_machines | length }}"
          machines: "{{ deployed_machines | map(attribute='hostname') | list }}"
          status: "completed"
          tracking_file: "{{ tracking_file.dest }}"
      when: management_server_url is defined
      ignore_errors: true

    - name: Generate provisioning report
      template:
        src: templates/provision-report.j2
        dest: "/tmp/gough-provision-report-{{ ansible_date_time.epoch }}.html"
      vars:
        report_machines: "{{ deployed_machines }}"
        report_role: "{{ provision_role }}"
        report_environment: "{{ provision_environment }}"

    - name: Display provisioning summary
      debug:
        msg: |
          === Provisioning Complete ===
          Successfully deployed: {{ deployed_machines | length }} servers
          Role: {{ provision_role }}
          Environment: {{ provision_environment }}
          Tracking file: {{ tracking_file.dest }}
          Report: /tmp/gough-provision-report-{{ ansible_date_time.epoch }}.html
          =============================
          
          Deployed Servers:
          {% for machine in deployed_machines %}
          - {{ machine.hostname }} ({{ machine.ip_addresses[0] if machine.ip_addresses else 'No IP' }})
          {% endfor %}

  handlers:
    - name: Log provisioning failure
      copy:
        content: |
          Provisioning failed: {{ ansible_date_time.iso8601 }}
          Error: {{ ansible_failed_result.msg if ansible_failed_result is defined else 'Unknown error' }}
          Environment: {{ provision_environment }}
          Role: {{ provision_role }}
          Count: {{ provision_count }}
        dest: "/tmp/gough-provision-failure-{{ ansible_date_time.epoch }}.log"
      when: ansible_failed_result is defined