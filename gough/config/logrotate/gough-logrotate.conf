# Gough Hypervisor Log Rotation Configuration
# Automated log management for all Gough services
# Designed for production environments with high log volume

# Global defaults for Gough logs
# These can be overridden in individual service configurations

# =================================
# MAAS LOGS
# =================================

/var/log/maas/*.log {
    # Rotation frequency and retention
    daily
    rotate 30
    maxsize 100M
    
    # Compression and cleanup
    compress
    delaycompress
    compresscmd /usr/bin/gzip
    compressext .gz
    
    # File handling
    missingok
    notifempty
    create 644 maas maas
    
    # Post-rotation actions
    postrotate
        # Signal MaaS processes to reopen log files
        systemctl reload maas-regiond 2>/dev/null || true
        systemctl reload maas-rackd 2>/dev/null || true
        
        # Send notification
        echo "MaaS logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    # Copy and truncate for active processes
    copytruncate
}

# MaaS Audit Logs (longer retention)
/var/log/maas/audit.log {
    daily
    rotate 90
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 maas maas
    copytruncate
}

# =================================
# MANAGEMENT SERVER LOGS
# =================================

/var/log/gough/management-server*.log {
    daily
    rotate 14
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    
    postrotate
        # Send USR1 signal to py4web processes to reopen logs
        pkill -USR1 -f py4web 2>/dev/null || true
        
        # Docker container log rotation
        if docker ps --format "table {{.Names}}" | grep -q management-server; then
            docker kill --signal="USR1" management-server 2>/dev/null || true
        fi
        
        echo "Management server logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# Management server access logs
/var/log/gough/access*.log {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    copytruncate
}

# =================================
# POSTGRESQL LOGS
# =================================

/var/log/postgresql/postgresql-*.log {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 postgres postgres
    
    postrotate
        # Send SIGHUP to PostgreSQL to reopen log files
        systemctl reload postgresql 2>/dev/null || true
        
        # For Docker containers
        if docker ps --format "table {{.Names}}" | grep -q postgres; then
            docker exec postgres-primary pg_ctl reload -D /var/lib/postgresql/data 2>/dev/null || true
            docker exec postgres-replica pg_ctl reload -D /var/lib/postgresql/data 2>/dev/null || true
        fi
        
        echo "PostgreSQL logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# PostgreSQL slow query logs
/var/log/postgresql/postgresql-slow.log {
    weekly
    rotate 4
    maxsize 200M
    compress
    delaycompress
    missingok
    notifempty
    create 644 postgres postgres
    copytruncate
}

# =================================
# MYSQL/MARIADB LOGS
# =================================

/var/log/mysql/*.log {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 mysql mysql
    
    postrotate
        # Send SIGHUP to MySQL/MariaDB
        systemctl reload mysql 2>/dev/null || systemctl reload mariadb 2>/dev/null || true
        
        # For Docker containers
        if docker ps --format "table {{.Names}}" | grep -q mysql; then
            docker exec mysql mysqladmin --user=root --password="$MYSQL_ROOT_PASSWORD" flush-logs 2>/dev/null || true
        fi
        
        echo "MySQL logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# MySQL slow query log (longer retention)
/var/log/mysql/mysql-slow.log {
    weekly
    rotate 8
    maxsize 500M
    compress
    delaycompress
    missingok
    notifempty
    create 644 mysql mysql
    copytruncate
}

# =================================
# REDIS LOGS
# =================================

/var/log/redis/redis-server.log {
    weekly
    rotate 4
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 redis redis
    
    postrotate
        # Redis doesn't need signal - it handles log rotation automatically
        echo "Redis logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    copytruncate
}

# =================================
# FLEETDM LOGS
# =================================

/var/log/gough/fleetdm*.log {
    daily
    rotate 14
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 fleet fleet
    
    postrotate
        # Send USR1 signal to FleetDM process
        pkill -USR1 -f fleet 2>/dev/null || true
        
        # Docker container signal
        if docker ps --format "table {{.Names}}" | grep -q fleetdm; then
            docker kill --signal="USR1" fleetdm 2>/dev/null || true
        fi
        
        echo "FleetDM logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# =================================
# NGINX LOGS
# =================================

/var/log/nginx/*.log {
    daily
    rotate 14
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    
    prerotate
        # Test nginx configuration before rotation
        nginx -t 2>/dev/null || exit 1
    endscript
    
    postrotate
        # Send USR1 signal to nginx to reopen log files
        systemctl reload nginx 2>/dev/null || true
        
        # Docker container signal
        if docker ps --format "table {{.Names}}" | grep -q nginx; then
            docker kill --signal="USR1" nginx-lb 2>/dev/null || true
        fi
        
        echo "Nginx logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# =================================
# HAPROXY LOGS
# =================================

/var/log/haproxy/haproxy*.log {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 haproxy haproxy
    
    postrotate
        # Send USR1 signal to HAProxy
        systemctl reload haproxy 2>/dev/null || true
        
        # Docker container signal
        if docker ps --format "table {{.Names}}" | grep -q haproxy; then
            docker kill --signal="USR1" haproxy-maas 2>/dev/null || true
        fi
        
        echo "HAProxy logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    copytruncate
}

# =================================
# MONITORING LOGS (ELK STACK)
# =================================

# Elasticsearch logs
/var/log/elasticsearch/elasticsearch*.log {
    daily
    rotate 7
    maxsize 200M
    compress
    delaycompress
    missingok
    notifempty
    create 644 elasticsearch elasticsearch
    copytruncate
    
    postrotate
        echo "Elasticsearch logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# Logstash logs
/var/log/logstash/logstash*.log {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 logstash logstash
    
    postrotate
        # Send SIGHUP to Logstash
        pkill -HUP -f logstash 2>/dev/null || true
        
        # Docker container
        if docker ps --format "table {{.Names}}" | grep -q logstash; then
            docker kill --signal="HUP" logstash 2>/dev/null || true
        fi
        
        echo "Logstash logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# Kibana logs
/var/log/kibana/kibana*.log {
    daily
    rotate 7
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 kibana kibana
    copytruncate
    
    postrotate
        echo "Kibana logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# Filebeat logs
/var/log/filebeat/filebeat*.log {
    weekly
    rotate 4
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 filebeat filebeat
    copytruncate
}

# =================================
# PROMETHEUS & GRAFANA LOGS
# =================================

# Prometheus logs
/var/log/prometheus/prometheus*.log {
    daily
    rotate 7
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 prometheus prometheus
    
    postrotate
        # Send SIGHUP to Prometheus
        pkill -HUP -f prometheus 2>/dev/null || true
        
        echo "Prometheus logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    copytruncate
}

# AlertManager logs
/var/log/alertmanager/alertmanager*.log {
    daily
    rotate 7
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 alertmanager alertmanager
    copytruncate
}

# Grafana logs
/var/log/grafana/grafana*.log {
    daily
    rotate 14
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 grafana grafana
    
    postrotate
        # Send SIGHUP to Grafana
        pkill -HUP -f grafana-server 2>/dev/null || true
        
        echo "Grafana logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    copytruncate
}

# =================================
# GOUGH SYSTEM LOGS
# =================================

# Main Gough application logs
/var/log/gough/*.log {
    daily
    rotate 30
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 gough gough
    
    postrotate
        echo "Gough system logs rotated on $(date)" | logger -t gough-logrotate
        
        # Send notification to monitoring
        curl -s -X POST "$SLACK_WEBHOOK" \
             -d '{"channel":"#gough-operations","text":"ðŸ“„ Log rotation completed on '"$(hostname)"' at '"$(date)"'"}' \
             -H 'Content-type: application/json' 2>/dev/null || true
    endscript
    
    copytruncate
}

# Gough backup logs (longer retention)
/var/log/gough/backup*.log {
    weekly
    rotate 12
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 gough gough
    copytruncate
}

# Gough maintenance logs
/var/log/gough/*maintenance*.log {
    weekly
    rotate 8
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 gough gough
    copytruncate
}

# Gough image update logs
/var/log/gough/*image*.log {
    weekly
    rotate 12
    maxsize 50M
    compress
    delaycompress
    missingok
    notifempty
    create 644 gough gough
    copytruncate
}

# =================================
# DOCKER CONTAINER LOGS
# =================================

# Docker daemon logs
/var/log/docker/docker*.log {
    weekly
    rotate 4
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    
    postrotate
        systemctl reload docker 2>/dev/null || true
        echo "Docker logs rotated on $(date)" | logger -t gough-logrotate
    endscript
    
    copytruncate
}

# =================================
# SYSTEM LOGS (GOUGH SPECIFIC)
# =================================

# Syslog entries for Gough services
/var/log/messages {
    daily
    rotate 7
    maxsize 100M
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    
    postrotate
        systemctl reload rsyslog 2>/dev/null || true
    endscript
    
    # Only if file exists and contains Gough entries
    prerotate
        if [ -f /var/log/messages ] && grep -q "gough" /var/log/messages 2>/dev/null; then
            # Extract Gough entries to separate log
            grep "gough" /var/log/messages > /var/log/gough/system.log.$(date +%Y%m%d) 2>/dev/null || true
        fi
    endscript
}

# =================================
# AUDIT LOGS
# =================================

# System audit logs containing Gough activities
/var/log/audit/audit.log {
    daily
    rotate 30
    maxsize 200M
    compress
    delaycompress
    missingok
    notifempty
    create 600 root root
    
    postrotate
        # Restart auditd to reopen log files
        systemctl restart auditd 2>/dev/null || service auditd restart 2>/dev/null || true
        echo "Audit logs rotated on $(date)" | logger -t gough-logrotate
    endscript
}

# =================================
# CLEANUP SCRIPTS
# =================================

# Custom cleanup for very old compressed logs
/var/log/*/*.gz {
    maxage 365
    missingok
    
    prerotate
        # Remove logs older than 1 year
        find /var/log -name "*.gz" -mtime +365 -delete 2>/dev/null || true
        echo "Cleaned up logs older than 365 days" | logger -t gough-logrotate
    endscript
}

# =================================
# EMERGENCY CLEANUP
# =================================

# Emergency cleanup when disk space is low
# This should be called by a monitoring script when disk usage > 90%
/var/log/gough/emergency-cleanup.log {
    size 1k
    rotate 1
    missingok
    notifempty
    create 644 gough gough
    
    prerotate
        # Get disk usage percentage
        DISK_USAGE=$(df /var/log | awk 'NR==2 {print $5}' | sed 's/%//')
        
        if [ "$DISK_USAGE" -gt 90 ]; then
            echo "Emergency cleanup triggered - disk usage: ${DISK_USAGE}%" | logger -t gough-emergency
            
            # Compress all uncompressed logs immediately
            find /var/log -name "*.log" -size +10M -exec gzip {} \; 2>/dev/null || true
            
            # Remove old compressed logs more aggressively
            find /var/log -name "*.gz" -mtime +7 -delete 2>/dev/null || true
            
            # Send alert
            curl -s -X POST "$SLACK_WEBHOOK" \
                 -d '{"channel":"#gough-critical","text":"ðŸš¨ Emergency log cleanup triggered on '"$(hostname)"' - disk usage: '"${DISK_USAGE}"'%"}' \
                 -H 'Content-type: application/json' 2>/dev/null || true
        fi
    endscript
}