# Filebeat Configuration for Gough Hypervisor
# Ships logs from containers and system to Logstash/Elasticsearch

# Global configuration
name: "gough-filebeat"
tags: ["gough", "hypervisor", "logs"]
fields:
  environment: production
  infrastructure: gough-hypervisor
fields_under_root: true

# Filebeat inputs
filebeat.inputs:
  # Docker container logs
  - type: docker
    enabled: true
    containers.ids: "*"
    paths:
      - /var/lib/docker/containers/*/*.log
    fields:
      log_type: container
    fields_under_root: true
    multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
    multiline.negate: true
    multiline.match: after
    multiline.timeout: 30s
    processors:
      - add_docker_metadata:
          host: "unix:///var/run/docker.sock"
      - decode_json_fields:
          fields: ["message"]
          target: "docker"

  # System logs
  - type: syslog
    enabled: true
    protocol.udp:
      host: "0.0.0.0:514"
    fields:
      log_type: system
      service: syslog

  # MaaS logs
  - type: log
    enabled: true
    paths:
      - /var/log/maas/*.log
      - /var/log/maas/**/*.log
    fields:
      service: maas
      log_type: application
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after
    exclude_files: ['\.gz$']

  # Management server logs
  - type: log
    enabled: true
    paths:
      - /var/log/py4web/*.log
      - /opt/py4web-apps/*/logs/*.log
    fields:
      service: management-server
      log_type: application
    exclude_files: ['\.gz$']

  # FleetDM logs
  - type: log
    enabled: true
    paths:
      - /var/log/fleet/*.log
    fields:
      service: fleetdm
      log_type: application
    exclude_files: ['\.gz$']

  # Database logs
  - type: log
    enabled: true
    paths:
      - /var/log/postgresql/*.log
    fields:
      service: postgres
      log_type: database
    exclude_files: ['\.gz$']

  - type: log
    enabled: true
    paths:
      - /var/log/mysql/*.log
      - /var/log/mysql/error.log
    fields:
      service: mysql
      log_type: database
    exclude_files: ['\.gz$']

  # Nginx logs
  - type: log
    enabled: true
    paths:
      - /var/log/nginx/access.log
      - /var/log/nginx/error.log
    fields:
      service: nginx
      log_type: webserver
    exclude_files: ['\.gz$']

  # Redis logs
  - type: log
    enabled: true
    paths:
      - /var/log/redis/*.log
    fields:
      service: redis
      log_type: cache
    exclude_files: ['\.gz$']

  # Audit logs
  - type: log
    enabled: true
    paths:
      - /var/log/audit/audit.log
    fields:
      service: audit
      log_type: security
    exclude_files: ['\.gz$']

# Filebeat modules
filebeat.modules:
  - module: system
    syslog:
      enabled: true
      var.paths: ["/var/log/syslog*"]
    auth:
      enabled: true
      var.paths: ["/var/log/auth.log*"]

  - module: nginx
    access:
      enabled: true
      var.paths: ["/var/log/nginx/access.log*"]
    error:
      enabled: true
      var.paths: ["/var/log/nginx/error.log*"]

  - module: mysql
    error:
      enabled: true
      var.paths: ["/var/log/mysql/error.log*"]
    slowlog:
      enabled: true
      var.paths: ["/var/log/mysql/mysql-slow.log*"]

  - module: postgresql
    log:
      enabled: true
      var.paths: ["/var/log/postgresql/postgresql-*.log*"]

# Processors
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~
  - drop_event:
      when:
        or:
          - contains:
              message: "healthcheck"
          - contains:
              message: "ping"
          - regexp:
              message: "^\\s*$"

# Output configuration
output.logstash:
  hosts: ["logstash:5044"]
  compression_level: 3
  bulk_max_size: 2048
  worker: 2

# Alternative direct Elasticsearch output
# output.elasticsearch:
#   hosts: ["elasticsearch:9200"]
#   index: "gough-logs-%{+yyyy.MM.dd}"
#   template.pattern: "gough-logs-*"
#   template.settings:
#     index.number_of_shards: 1
#     index.number_of_replicas: 0

# Monitoring
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["elasticsearch:9200"]

# Logging
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat.log
  keepfiles: 7
  permissions: 0644

# Queue configuration
queue.mem:
  events: 4096
  flush.min_events: 512
  flush.timeout: 5s

# Registry
filebeat.registry.path: /usr/share/filebeat/data/registry

# HTTP endpoint for health checks
http.enabled: true
http.host: 0.0.0.0
http.port: 5066