# HAProxy Configuration for MaaS High Availability
# Load balancing for MaaS Region Controllers with health checks and failover
# Optimized for 100+ server enterprise deployment

global
    log stdout local0 info
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Security hardening
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 1024
    
    # Resource limits for high load
    maxconn 4096
    spread-checks 4

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option httpclose
    
    # Timeouts optimized for enterprise load
    timeout connect 10s
    timeout client 60s
    timeout server 60s
    timeout http-request 30s
    timeout http-keep-alive 10s
    timeout check 10s
    
    # Error handling
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http
    
    # Health check configuration
    default-server inter 5000ms downinter 1000ms rise 2 fall 3

# =================================
# STATISTICS & MONITORING
# =================================

frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-desc "Gough MaaS HA Load Balancer"
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD:-admin123}
    
    # Prometheus metrics export
    http-request use-service prometheus-exporter if { path /metrics }

# =================================
# MAAS WEB UI LOAD BALANCER
# =================================

frontend maas_web_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/maas.pem alpn h2,http/1.1
    mode http
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Redirect HTTP to HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Request routing based on path
    acl is_api path_beg /MAAS/api/
    acl is_metadata path_beg /MAAS/metadata/
    acl is_images path_beg /MAAS/images/
    acl is_websocket hdr(Upgrade) -i websocket
    
    # Route to appropriate backend
    use_backend maas_api_backend if is_api
    use_backend maas_metadata_backend if is_metadata
    use_backend maas_images_backend if is_images
    use_backend maas_websocket_backend if is_websocket
    default_backend maas_web_backend
    
    # Rate limiting to prevent abuse
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 100 }

# =================================
# MAAS API LOAD BALANCER
# =================================

frontend maas_api_frontend
    bind *:5240
    bind *:5241 ssl crt /etc/ssl/certs/maas-api.pem
    mode http
    
    # API-specific headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
    
    # Handle CORS preflight
    http-request return status 200 if METH_OPTIONS
    
    default_backend maas_api_backend
    
    # API rate limiting (higher limits for API)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 1000 }

# =================================
# BACKEND SERVERS
# =================================

# MaaS Web Interface Backend
backend maas_web_backend
    mode http
    balance roundrobin
    option httpchk GET /MAAS/ HTTP/1.1\r\nHost:\ maas.local
    http-check expect status 200
    
    # Primary MaaS region controller
    server maas-primary maas-region-primary:5240 check weight 100 cookie primary
    
    # Secondary MaaS region controller (backup)
    server maas-secondary maas-region-secondary:5240 check weight 50 cookie secondary backup
    
    # Connection pooling and keep-alive
    http-reuse always
    
    # Session persistence for web UI
    cookie MAASSERVER insert indirect nocache
    
    # Health monitoring
    option log-health-checks

# MaaS API Backend
backend maas_api_backend
    mode http
    balance leastconn
    option httpchk GET /MAAS/api/2.0/version/ HTTP/1.1\r\nHost:\ maas.local
    http-check expect status 200
    
    # Primary MaaS region controller
    server maas-primary maas-region-primary:5241 check weight 100 maxconn 500
    
    # Secondary MaaS region controller (backup)
    server maas-secondary maas-region-secondary:5241 check weight 50 maxconn 300 backup
    
    # API-specific optimizations
    http-reuse always
    option prefer-last-server
    
    # Retry policy for API calls
    retries 3
    option redispatch

# MaaS Metadata Backend
backend maas_metadata_backend
    mode http
    balance roundrobin
    option httpchk GET /MAAS/metadata/status HTTP/1.1\r\nHost:\ maas.local
    http-check expect status 200
    
    # Both region controllers serve metadata
    server maas-primary maas-region-primary:5247 check weight 100
    server maas-secondary maas-region-secondary:5247 check weight 100
    
    # Metadata is read-only, so both can serve equally
    option httpchk

# MaaS Images Backend (for large file downloads)
backend maas_images_backend
    mode http
    balance roundrobin
    option httpchk HEAD /MAAS/images/ HTTP/1.1\r\nHost:\ maas.local
    
    # Higher timeouts for large image downloads
    timeout server 300s
    timeout connect 30s
    
    # Both controllers can serve images from shared storage
    server maas-primary maas-region-primary:5240 check weight 100
    server maas-secondary maas-region-secondary:5240 check weight 100

# WebSocket Backend for real-time updates
backend maas_websocket_backend
    mode http
    balance source
    option httpchk GET /MAAS/ws HTTP/1.1\r\nConnection:\ Upgrade\r\nUpgrade:\ websocket\r\nHost:\ maas.local
    
    # Sticky sessions required for websockets
    hash-type consistent
    
    server maas-primary maas-region-primary:5240 check weight 100
    server maas-secondary maas-region-secondary:5240 check weight 50 backup
    
    # WebSocket specific timeouts
    timeout tunnel 1h
    timeout client 1h
    timeout server 1h

# =================================
# DATABASE LOAD BALANCER
# =================================

frontend postgres_frontend
    bind *:5432
    mode tcp
    default_backend postgres_backend

backend postgres_backend
    mode tcp
    balance first
    option tcp-check
    tcp-check connect port 5432
    tcp-check send-binary "00000020000003000064617461626173650006706f737467726573007573657200066d61617300" # PostgreSQL startup packet
    tcp-check expect binary "52000000080000000a" # Authentication OK
    
    # Primary database (read/write)
    server postgres-primary postgres-primary:5432 check weight 100
    
    # Replica database (read-only) - only used if primary fails
    server postgres-replica postgres-replica:5432 check weight 0 backup

# Read-only database queries backend
backend postgres_readonly_backend
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect port 5432
    tcp-check send-binary "00000020000003000064617461626173650006706f737467726573007573657200066d61617300"
    tcp-check expect binary "52000000080000000a"
    
    # Both can serve read queries
    server postgres-primary postgres-primary:5432 check weight 50
    server postgres-replica postgres-replica:5432 check weight 100

# =================================
# SERVICE HEALTH MONITORING
# =================================

# Health check endpoints for external monitoring
frontend health_frontend
    bind *:8080
    mode http
    
    # Health check endpoint
    acl health_check path /health
    http-request return status 200 content-type "application/json" string "{\"status\":\"healthy\",\"timestamp\":\"$(date)\",\"version\":\"1.0\"}" if health_check
    
    # Detailed status endpoint
    acl status_check path /status
    use_backend status_backend if status_check
    
    # Default to 404 for other paths
    http-request return status 404

backend status_backend
    mode http
    server healthcheck healthcheck-service:9999 check