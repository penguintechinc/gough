# PostgreSQL Configuration for High Availability
# Optimized for MaaS database replication and enterprise workloads
# Supports 100+ server deployments with read/write splitting

# =================================
# CONNECTION SETTINGS
# =================================

# Network configuration
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Authentication
authentication_timeout = 60s
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'
ssl_crl_file = '/etc/ssl/certs/server.crl'

# Connection pooling
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =================================
# MEMORY SETTINGS
# =================================

# Buffer management
shared_buffers = 256MB                  # 25% of available RAM for dedicated DB server
effective_cache_size = 1GB              # Estimate of available OS cache
work_mem = 4MB                          # Per-query working memory
maintenance_work_mem = 64MB             # For maintenance operations
dynamic_shared_memory_type = posix

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# =================================
# WAL SETTINGS (Critical for Replication)
# =================================

# Write-Ahead Logging
wal_level = replica                     # Enable streaming replication
wal_buffers = 16MB                      # WAL buffer size
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# Checkpointing
checkpoint_timeout = 15min              # Maximum time between checkpoints
checkpoint_completion_target = 0.9      # Spread checkpoint I/O
checkpoint_warning = 30s
checkpoint_flush_after = 256kB

# WAL archiving and retention
archive_mode = on                       # Enable WAL archiving
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
archive_timeout = 300s                  # Archive WAL files every 5 minutes

# WAL file management
min_wal_size = 1GB                      # Minimum WAL size
max_wal_size = 4GB                      # Maximum WAL size before forced checkpoint
wal_keep_size = 2GB                     # Keep WAL files for standby servers
wal_receiver_status_interval = 10s      # Status update frequency from standby
max_wal_senders = 3                     # Maximum concurrent WAL senders
max_replication_slots = 3               # Maximum replication slots

# =================================
# REPLICATION SETTINGS
# =================================

# Streaming replication
hot_standby = on                        # Allow read queries on standby
hot_standby_feedback = on               # Prevent query conflicts
wal_receiver_timeout = 60s              # WAL receiver timeout
max_standby_streaming_delay = 30s       # Maximum delay for streaming standby
max_standby_archive_delay = 30s         # Maximum delay for archive recovery

# Replication slots and backup
max_replication_slots = 3
wal_sender_timeout = 60s
track_commit_timestamp = on             # Track commit timestamps

# =================================
# QUERY TUNING
# =================================

# Query planner
random_page_cost = 1.1                  # SSD storage assumption
effective_io_concurrency = 200          # Concurrent I/O operations (SSD)
seq_page_cost = 1.0                     # Sequential page cost
default_statistics_target = 100         # Statistics target for query planning

# Parallel processing
max_worker_processes = 8                # Maximum background processes
max_parallel_workers_per_gather = 4     # Parallel workers per query
max_parallel_workers = 8                # Maximum parallel workers
max_parallel_maintenance_workers = 4     # Parallel maintenance workers

# Join and sort settings
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# =================================
# LOGGING CONFIGURATION
# =================================

# Logging collector
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%a.log'
log_file_mode = 0644
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_min_messages = info                 # Minimum message level
log_min_error_statement = error         # Log statements causing errors
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_statement = 'ddl'                   # Log DDL statements
log_duration = off                      # Don't log statement duration
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Connection logging
log_connections = on
log_disconnections = on
log_hostname = off
log_lock_waits = on
log_temp_files = 10MB

# Replication logging
log_replication_commands = on

# =================================
# RUNTIME STATISTICS
# =================================

# Statistics collector
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/stats_temp'

# =================================
# CLIENT CONNECTION DEFAULTS
# =================================

# Locale settings
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default transaction isolation
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off

# Statement timeout
statement_timeout = 300s                # 5 minute query timeout
lock_timeout = 30s                      # Lock timeout
idle_in_transaction_session_timeout = 60s

# =================================
# ERROR HANDLING
# =================================

# Restart after backend crash
restart_after_crash = on
max_files_per_process = 1000

# =================================
# VACUUM AND ANALYZE SETTINGS
# =================================

# Autovacuum settings
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

# =================================
# EXTENSIONS AND MODULES
# =================================

shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# =================================
# CUSTOM SETTINGS FOR MAAS
# =================================

# MaaS-specific optimizations
# These settings are tuned for the typical MaaS workload patterns

# Connection pooling recommendations
# Use pgbouncer or similar for production deployments

# Monitoring and alerting
# Configure pg_stat_user_tables and pg_stat_database monitoring