# PagerDuty Integration Configuration for Gough HA
# Enterprise incident management and escalation policies
# Supports multiple services with appropriate routing keys

# PagerDuty Service Configuration
# Configure these routing keys in your PagerDuty account

pagerduty:
  # Critical Infrastructure Service
  critical:
    routing_key: "${PAGERDUTY_ROUTING_KEY_CRITICAL}"
    description: "Critical infrastructure alerts requiring immediate response"
    escalation_policy: "Critical Infrastructure Escalation"
    service_name: "Gough Critical Infrastructure"
    
    # Alert routing rules
    rules:
      - match:
          severity: critical
        routing_key: "${PAGERDUTY_ROUTING_KEY_CRITICAL}"
        summary_template: "{{ .GroupLabels.alertname }}: Critical issue in {{ .CommonLabels.service | default \"unknown\" }}"
        details:
          severity: "{{ .CommonLabels.severity }}"
          environment: "{{ .CommonLabels.environment | default \"production\" }}"
          cluster: "{{ .CommonLabels.cluster | default \"gough-cluster\" }}"
          service: "{{ .CommonLabels.service }}"
          instance: "{{ .CommonLabels.instance }}"
          firing_count: "{{ .Alerts.Firing | len }}"
          description: |
            {{ range .Alerts }}
            Alert: {{ .Annotations.summary }}
            Description: {{ .Annotations.description }}
            Instance: {{ .Labels.instance }}
            Started: {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
            {{ if .Annotations.runbook_url }}Runbook: {{ .Annotations.runbook_url }}{{ end }}
            {{ if .Annotations.action }}Action Required: {{ .Annotations.action }}{{ end }}
            
            {{ end }}

  # MaaS Service Alerts
  maas:
    routing_key: "${PAGERDUTY_ROUTING_KEY_MAAS}"
    description: "MaaS service alerts and provisioning issues"
    escalation_policy: "Infrastructure Team Escalation"
    service_name: "Gough MaaS Service"
    
    rules:
      - match:
          service: "maas"
          severity: "critical"
        routing_key: "${PAGERDUTY_ROUTING_KEY_MAAS}"
        summary_template: "MaaS Critical: {{ .GroupLabels.alertname }}"
        details:
          service_type: "maas"
          component: "{{ .CommonLabels.component | default \"unknown\" }}"
          role: "{{ .CommonLabels.role | default \"unknown\" }}"
          impact: "Server provisioning and bare metal management affected"

  # Database Service Alerts
  database:
    routing_key: "${PAGERDUTY_ROUTING_KEY_DATABASE}"
    description: "Database service alerts including PostgreSQL and MySQL"
    escalation_policy: "Database Team Escalation"
    service_name: "Gough Database Service"
    
    rules:
      - match_re:
          service: "(postgresql|mysql|redis)"
          severity: "critical"
        routing_key: "${PAGERDUTY_ROUTING_KEY_DATABASE}"
        summary_template: "Database Critical: {{ .GroupLabels.alertname }} on {{ .CommonLabels.service }}"
        details:
          database_type: "{{ .CommonLabels.service }}"
          database_role: "{{ .CommonLabels.role | default \"unknown\" }}"
          impact: "Data integrity or availability compromised"

  # Security Alerts
  security:
    routing_key: "${PAGERDUTY_ROUTING_KEY_SECURITY}"
    description: "Security-related alerts requiring immediate attention"
    escalation_policy: "Security Team Escalation"
    service_name: "Gough Security Service"
    
    rules:
      - match_re:
          alertname: "(SecurityBreach|UnauthorizedAccess|TLSCertificateExpiry|VulnerabilityDetected)"
        routing_key: "${PAGERDUTY_ROUTING_KEY_SECURITY}"
        summary_template: "Security Alert: {{ .GroupLabels.alertname }}"
        details:
          security_type: "{{ .CommonLabels.alertname }}"
          threat_level: "{{ .CommonLabels.severity | default \"medium\" }}"
          impact: "Potential security compromise detected"
          immediate_action: "Review logs and take protective measures"

  # Management Server Alerts
  management:
    routing_key: "${PAGERDUTY_ROUTING_KEY_MANAGEMENT}"
    description: "Management server and portal alerts"
    escalation_policy: "Development Team Escalation"
    service_name: "Gough Management Portal"
    
    rules:
      - match:
          service: "management-server"
          severity: "critical"
        routing_key: "${PAGERDUTY_ROUTING_KEY_MANAGEMENT}"
        summary_template: "Management Portal Critical: {{ .GroupLabels.alertname }}"
        details:
          service_type: "management-portal"
          impact: "Gough web interface and API unavailable"

  # FleetDM Service Alerts
  fleetdm:
    routing_key: "${PAGERDUTY_ROUTING_KEY_FLEETDM}"
    description: "FleetDM and OSQuery monitoring alerts"
    escalation_policy: "Security Team Escalation"
    service_name: "Gough FleetDM Service"
    
    rules:
      - match:
          service: "fleetdm"
          severity: "critical"
        routing_key: "${PAGERDUTY_ROUTING_KEY_FLEETDM}"
        summary_template: "FleetDM Critical: {{ .GroupLabels.alertname }}"
        details:
          service_type: "fleetdm"
          impact: "Security monitoring and compliance reporting affected"

  # Monitoring Infrastructure
  monitoring:
    routing_key: "${PAGERDUTY_ROUTING_KEY_MONITORING}"
    description: "Monitoring stack alerts (Prometheus, Grafana, ELK)"
    escalation_policy: "DevOps Team Escalation"
    service_name: "Gough Monitoring Stack"
    
    rules:
      - match_re:
          service: "(prometheus|grafana|elasticsearch|kibana|alertmanager)"
          severity: "critical"
        routing_key: "${PAGERDUTY_ROUTING_KEY_MONITORING}"
        summary_template: "Monitoring Critical: {{ .GroupLabels.alertname }}"
        details:
          monitoring_component: "{{ .CommonLabels.service }}"
          impact: "Monitoring and alerting capabilities degraded"

# Escalation Policies Configuration
escalation_policies:
  "Critical Infrastructure Escalation":
    description: "24/7 critical infrastructure support"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_ONCALL_L1}"
      - escalation_delay_in_minutes: 5
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_ONCALL_L2}"
      - escalation_delay_in_minutes: 15
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_MANAGER}"
  
  "Infrastructure Team Escalation":
    description: "Infrastructure team escalation for MaaS and networking"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_INFRASTRUCTURE_PRIMARY}"
      - escalation_delay_in_minutes: 10
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_INFRASTRUCTURE_SECONDARY}"
      - escalation_delay_in_minutes: 30
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_INFRASTRUCTURE_MANAGER}"
  
  "Database Team Escalation":
    description: "Database specialists for critical data issues"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DBA_PRIMARY}"
      - escalation_delay_in_minutes: 10
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DBA_SECONDARY}"
      - escalation_delay_in_minutes: 30
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DBA_MANAGER}"
  
  "Security Team Escalation":
    description: "Security team for incidents and threats"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_SECURITY_PRIMARY}"
      - escalation_delay_in_minutes: 5
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_SECURITY_SECONDARY}"
      - escalation_delay_in_minutes: 15
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_SECURITY_MANAGER}"
  
  "Development Team Escalation":
    description: "Development team for application issues"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEV_ONCALL}"
      - escalation_delay_in_minutes: 15
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEV_LEAD}"
      - escalation_delay_in_minutes: 60
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEV_MANAGER}"
  
  "DevOps Team Escalation":
    description: "DevOps team for infrastructure and deployment issues"
    escalation_rules:
      - escalation_delay_in_minutes: 0
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEVOPS_PRIMARY}"
      - escalation_delay_in_minutes: 15
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEVOPS_SECONDARY}"
      - escalation_delay_in_minutes: 45
        targets:
          - type: "user"
            id: "${PAGERDUTY_USER_DEVOPS_MANAGER}"

# Maintenance Windows Configuration
maintenance_windows:
  # Regular maintenance window
  scheduled_maintenance:
    name: "Gough Scheduled Maintenance"
    description: "Regular maintenance window for updates and patches"
    schedule:
      # Every Sunday 2 AM - 6 AM UTC
      start_time: "2024-01-07T02:00:00Z"
      end_time: "2024-01-07T06:00:00Z"
      recurrence:
        type: "weekly"
        frequency: 1
        weekdays: ["sunday"]
    
    # Services affected during maintenance
    services:
      - "${PAGERDUTY_SERVICE_ID_CRITICAL}"
      - "${PAGERDUTY_SERVICE_ID_MAAS}"
      - "${PAGERDUTY_SERVICE_ID_DATABASE}"
      - "${PAGERDUTY_SERVICE_ID_MANAGEMENT}"
  
  # Emergency maintenance
  emergency_maintenance:
    name: "Gough Emergency Maintenance"
    description: "Emergency maintenance for critical fixes"
    # Manually triggered, no schedule

# Notification Rules
notification_rules:
  # High urgency for critical alerts
  critical_notifications:
    urgency: "high"
    conditions:
      - severity: "critical"
    contact_methods:
      - type: "push_notification"
      - type: "sms"
      - type: "phone_call"
    
  # Low urgency for warnings
  warning_notifications:
    urgency: "low"
    conditions:
      - severity: "warning"
    contact_methods:
      - type: "email"
      - type: "push_notification"

# Integration Settings
integrations:
  slack:
    enabled: true
    webhook_url: "${SLACK_WEBHOOK_URL}"
    default_channel: "#gough-alerts"
    channels:
      critical: "#gough-critical"
      security: "#gough-security"
      infrastructure: "#gough-infrastructure"
      database: "#gough-database"
  
  email:
    enabled: true
    smtp:
      host: "${SMTP_HOST}"
      port: "${SMTP_PORT}"
      username: "${SMTP_USERNAME}"
      password: "${SMTP_PASSWORD}"
      tls: true
    
    templates:
      critical: "/etc/alertmanager/templates/critical-email.tmpl"
      warning: "/etc/alertmanager/templates/warning-email.tmpl"
      resolved: "/etc/alertmanager/templates/resolved-email.tmpl"
  
  webhook:
    enabled: true
    endpoints:
      - name: "custom-webhook"
        url: "${CUSTOM_WEBHOOK_URL}"
        method: "POST"
        headers:
          Authorization: "Bearer ${WEBHOOK_TOKEN}"
          Content-Type: "application/json"

# Alert Suppression Rules
suppression_rules:
  # Suppress alerts during known maintenance
  - name: "maintenance_suppression"
    matchers:
      - name: "maintenance"
        value: "true"
    comment: "Suppress alerts during scheduled maintenance"
  
  # Suppress test environment alerts outside business hours
  - name: "test_env_suppression"
    matchers:
      - name: "environment"
        value: "test"
    schedule:
      - start_time: "17:00"
        end_time: "09:00"
        weekdays: ["monday", "tuesday", "wednesday", "thursday", "friday"]
      - start_time: "00:00"
        end_time: "23:59"
        weekdays: ["saturday", "sunday"]
    comment: "Suppress test environment alerts outside business hours"

# Metrics and Monitoring
metrics:
  # Enable metrics export for monitoring AlertManager itself
  enabled: true
  port: 9093
  path: "/metrics"
  
  # Custom metrics
  custom_metrics:
    - name: "gough_alerts_total"
      help: "Total number of alerts processed by severity"
      type: "counter"
      labels: ["severity", "service", "environment"]
    
    - name: "gough_alert_processing_duration_seconds"
      help: "Time taken to process alerts"
      type: "histogram"
      labels: ["receiver", "status"]
    
    - name: "gough_pagerduty_notifications_total"
      help: "Total PagerDuty notifications sent"
      type: "counter"
      labels: ["service", "severity", "status"]