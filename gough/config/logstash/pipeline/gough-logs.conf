# Logstash Pipeline Configuration for Gough Hypervisor Logs
# Processes logs from MaaS, FleetDM, Management Server, and infrastructure components

input {
  # Beats input (Filebeat, Metricbeat)
  beats {
    port => 5044
    host => "0.0.0.0"
  }
  
  # Syslog input for system logs
  syslog {
    port => 5514
    host => "0.0.0.0"
  }
  
  # TCP input for application logs
  tcp {
    port => 5000
    host => "0.0.0.0"
    codec => json
  }
  
  # UDP input for high-volume logs
  udp {
    port => 5001
    host => "0.0.0.0"
  }
  
  # HTTP input for webhook logs
  http {
    port => 8080
    host => "0.0.0.0"
  }
}

filter {
  # Add common fields
  mutate {
    add_field => { "infrastructure" => "gough-hypervisor" }
    add_field => { "environment" => "production" }
  }

  # Parse container logs (Docker JSON format)
  if [fields][log_type] == "container" {
    json {
      source => "message"
      target => "docker"
    }
    
    if [docker][log] {
      mutate {
        rename => { "[docker][log]" => "message" }
      }
    }
    
    # Extract container name and service
    if [docker][attrs][name] {
      mutate {
        add_field => { "container_name" => "%{[docker][attrs][name]}" }
      }
    }
  }

  # Parse MaaS logs
  if [fields][service] == "maas" or [container_name] =~ /.*maas.*/ {
    grok {
      match => { 
        "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{WORD:log_level}: %{GREEDYDATA:log_message}" 
      }
    }
    
    mutate {
      add_field => { "service" => "maas" }
      add_field => { "service_type" => "provisioning" }
    }

    # Parse MaaS specific patterns
    if [log_message] =~ /commissioning/ {
      mutate { add_field => { "maas_action" => "commissioning" } }
    }
    
    if [log_message] =~ /deployment/ {
      mutate { add_field => { "maas_action" => "deployment" } }
    }
    
    if [log_message] =~ /PXE/ {
      mutate { add_field => { "maas_action" => "pxe_boot" } }
    }
  }

  # Parse FleetDM logs
  if [fields][service] == "fleetdm" or [container_name] =~ /.*fleet.*/ {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:log_level} %{GREEDYDATA:log_message}" 
      }
    }
    
    mutate {
      add_field => { "service" => "fleetdm" }
      add_field => { "service_type" => "security" }
    }

    # Parse FleetDM specific patterns
    if [log_message] =~ /query/ {
      mutate { add_field => { "fleet_action" => "query" } }
    }
    
    if [log_message] =~ /enrollment/ {
      mutate { add_field => { "fleet_action" => "enrollment" } }
    }
    
    if [log_message] =~ /osquery/ {
      mutate { add_field => { "fleet_action" => "osquery" } }
    }
  }

  # Parse Management Server logs (py4web)
  if [fields][service] == "management-server" or [container_name] =~ /.*management.*/ {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} - %{WORD:log_level} - %{GREEDYDATA:log_message}" 
      }
    }
    
    mutate {
      add_field => { "service" => "management-server" }
      add_field => { "service_type" => "web_application" }
    }

    # Parse HTTP requests
    if [log_message] =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}.*"(GET|POST|PUT|DELETE)/ {
      grok {
        match => {
          "log_message" => "%{IPORHOST:client_ip} - - \[%{HTTPDATE:request_time}\] \"%{WORD:http_method} %{URIPATHPARAM:request_path} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} %{NUMBER:response_size}"
        }
      }
      
      mutate {
        add_field => { "log_type" => "access_log" }
        convert => { "response_code" => "integer" }
        convert => { "response_size" => "integer" }
      }
    }
  }

  # Parse Database logs
  if [fields][service] == "postgres" or [container_name] =~ /.*postgres.*/ {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{NUMBER:pid}\] %{WORD:log_level}:  %{GREEDYDATA:log_message}" 
      }
    }
    
    mutate {
      add_field => { "service" => "postgresql" }
      add_field => { "service_type" => "database" }
    }

    # Parse slow queries
    if [log_message] =~ /duration:/ {
      grok {
        match => {
          "log_message" => "duration: %{NUMBER:query_duration:float} ms"
        }
      }
      
      if [query_duration] and [query_duration] > 1000 {
        mutate { add_field => { "slow_query" => "true" } }
      }
    }
  }

  # Parse MySQL logs (FleetDM database)
  if [fields][service] == "mysql" or [container_name] =~ /.*mysql.*/ {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{NUMBER:thread_id} \[%{WORD:log_level}\] %{GREEDYDATA:log_message}" 
      }
    }
    
    mutate {
      add_field => { "service" => "mysql" }
      add_field => { "service_type" => "database" }
    }
  }

  # Parse Nginx logs
  if [fields][service] == "nginx" or [container_name] =~ /.*nginx.*/ {
    grok {
      match => {
        "message" => "%{IPORHOST:client_ip} - %{DATA:user_name} \[%{HTTPDATE:request_time}\] \"%{WORD:http_method} %{DATA:request_path} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} %{NUMBER:response_size} \"%{DATA:referrer}\" \"%{DATA:user_agent}\""
      }
    }
    
    mutate {
      add_field => { "service" => "nginx" }
      add_field => { "service_type" => "web_server" }
      add_field => { "log_type" => "access_log" }
      convert => { "response_code" => "integer" }
      convert => { "response_size" => "integer" }
    }

    # Detect error responses
    if [response_code] >= 400 {
      mutate { add_field => { "error_response" => "true" } }
    }
    
    if [response_code] >= 500 {
      mutate { add_field => { "server_error" => "true" } }
    }
  }

  # Parse system logs
  if [fields][log_type] == "system" {
    grok {
      match => {
        "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{IPORHOST:host} %{DATA:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:log_message}"
      }
    }
    
    mutate {
      add_field => { "service_type" => "system" }
    }
  }

  # Add log severity based on log level
  if [log_level] {
    if [log_level] =~ /(?i)(error|err|fatal|critical)/ {
      mutate { add_field => { "severity" => "error" } }
    } else if [log_level] =~ /(?i)(warn|warning)/ {
      mutate { add_field => { "severity" => "warning" } }
    } else if [log_level] =~ /(?i)(info|information)/ {
      mutate { add_field => { "severity" => "info" } }
    } else if [log_level] =~ /(?i)(debug|trace)/ {
      mutate { add_field => { "severity" => "debug" } }
    } else {
      mutate { add_field => { "severity" => "unknown" } }
    }
  }

  # Normalize timestamp
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }

  # Clean up fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "docker" ]
  }

  # Add geolocation for client IPs (optional)
  if [client_ip] and [client_ip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.)/ {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
}

output {
  # Main Elasticsearch output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "gough-logs-%{+YYYY.MM.dd}"
    template_name => "gough-logs"
    template_pattern => "gough-logs-*"
    template => {
      "index_patterns" => ["gough-logs-*"]
      "settings" => {
        "number_of_shards" => 1
        "number_of_replicas" => 0
        "index.refresh_interval" => "30s"
        "index.codec" => "best_compression"
      }
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" }
          "message" => { "type" => "text", "analyzer" => "standard" }
          "service" => { "type" => "keyword" }
          "service_type" => { "type" => "keyword" }
          "log_level" => { "type" => "keyword" }
          "severity" => { "type" => "keyword" }
          "container_name" => { "type" => "keyword" }
          "client_ip" => { "type" => "ip" }
          "response_code" => { "type" => "integer" }
          "response_size" => { "type" => "long" }
          "query_duration" => { "type" => "float" }
        }
      }
    }
  }

  # Error logs to separate index
  if [severity] == "error" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "gough-errors-%{+YYYY.MM.dd}"
    }
  }

  # Security-related logs to separate index
  if [service] == "fleetdm" or [log_message] =~ /(?i)(authentication|authorization|security|intrusion)/ {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "gough-security-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (can be disabled in production)
  # stdout {
  #   codec => rubydebug
  # }
}