[[extend 'layout.html']]

[[block page_content]]
<!-- Server Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="[[=URL('servers/list')]]">Servers</a></li>
                <li class="breadcrumb-item active">[[=server.hostname or f'Server {server.id}']]</li>
            </ol>
        </nav>
        <h1 class="h3 mb-2">
            <i class="bi bi-server me-2"></i>[[=server.hostname or f'Server {server.id}']]
            [[status_class = 'status-unknown']]
            [[if server.status in ['Ready', 'Deployed', 'Online']:]]
                [[status_class = 'status-online']]
            [[elif server.status in ['Failed', 'Broken', 'Error']:]]
                [[status_class = 'status-offline']]
            [[elif server.status in ['Deploying', 'Commissioning', 'Testing']:]]
                [[status_class = 'status-running']]
            [[elif server.status in ['Available', 'New']:]]
                [[status_class = 'status-pending']]
            [[pass]]
            <span class="status-indicator [[=status_class]] ms-2">[[=server.status or 'Unknown']]</span>
        </h1>
        <p class="text-muted mb-0">Server details and management</p>
    </div>
    <div>
        <div class="btn-group">
            [[if server.status in ['Ready', 'Available', 'Deployed']:]]
            <a href="[[=URL('servers/deploy', server.id)]]" class="btn btn-success">
                <i class="bi bi-play"></i> Deploy
            </a>
            [[pass]]
            
            [[if server.maas_node_id:]]
            <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-power"></i> Power
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="powerAction([[=server.id]], 'on')">
                        <i class="bi bi-play text-success"></i> Power On</a></li>
                    <li><a class="dropdown-item" href="#" onclick="powerAction([[=server.id]], 'off')">
                        <i class="bi bi-stop text-danger"></i> Power Off</a></li>
                    <li><a class="dropdown-item" href="#" onclick="powerAction([[=server.id]], 'restart')">
                        <i class="bi bi-arrow-clockwise text-warning"></i> Restart</a></li>
                </ul>
            </div>
            [[pass]]
            
            <button class="btn btn-outline-primary" onclick="refreshServerStatus()">
                <i class="bi bi-arrow-repeat"></i> Refresh
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Server Information -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Server Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Hostname:</strong></td>
                        <td>[[=server.hostname or '-']]</td>
                    </tr>
                    <tr>
                        <td><strong>IP Address:</strong></td>
                        <td>[[=server.ip_address or '-']]</td>
                    </tr>
                    <tr>
                        <td><strong>MAC Address:</strong></td>
                        <td><code>[[=server.mac_address or '-']]</code></td>
                    </tr>
                    <tr>
                        <td><strong>Type:</strong></td>
                        <td><span class="badge bg-light text-dark">[[=server.server_type or 'Machine']]</span></td>
                    </tr>
                    <tr>
                        <td><strong>MaaS Node:</strong></td>
                        <td>
                            [[if server.maas_node_id:]]
                                <code>[[=server.maas_node_id]]</code>
                            [[else:]]
                                <span class="text-muted">Not managed</span>
                            [[pass]]
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Last Seen:</strong></td>
                        <td>
                            [[if server.last_seen:]]
                                [[=server.last_seen.strftime('%Y-%m-%d %H:%M:%S')]]
                            [[else:]]
                                <span class="text-muted">Never</span>
                            [[pass]]
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Hardware Specifications -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Hardware</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cpu fs-4 text-primary me-3"></i>
                            <div>
                                <div class="fw-bold">CPU</div>
                                <div class="text-muted">[[=f'{server.cpu_count} cores' if server.cpu_count else 'Unknown']]</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-memory fs-4 text-info me-3"></i>
                            <div>
                                <div class="fw-bold">Memory</div>
                                <div class="text-muted">
                                    [[if server.memory_mb:]]
                                        [[='{:.1f} GB'.format(server.memory_mb / 1024)]]
                                    [[else:]]
                                        Unknown
                                    [[pass]]
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hdd fs-4 text-warning me-3"></i>
                            <div>
                                <div class="fw-bold">Storage</div>
                                <div class="text-muted">
                                    [[if server.storage_gb:]]
                                        [[=f'{server.storage_gb} GB']]
                                    [[else:]]
                                        Unknown
                                    [[pass]]
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fleet Status -->
    <div class="col-lg-4 col-md-12 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Fleet Status</h5>
            </div>
            <div class="card-body">
                [[if fleet_host:]]
                    <div class="d-flex align-items-center mb-3">
                        <div class="fleet-host-status bg-[[='success' if fleet_host.online_status else 'danger']] me-3"></div>
                        <div>
                            <div class="fw-bold">[[='Online' if fleet_host.online_status else 'Offline']]</div>
                            <div class="text-muted">FleetDM Agent</div>
                        </div>
                    </div>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Host ID:</strong></td>
                            <td><code>[[=fleet_host.fleet_host_id]]</code></td>
                        </tr>
                        <tr>
                            <td><strong>Platform:</strong></td>
                            <td>[[=fleet_host.platform or '-']]</td>
                        </tr>
                        <tr>
                            <td><strong>OS Version:</strong></td>
                            <td>[[=fleet_host.os_version or '-']]</td>
                        </tr>
                        <tr>
                            <td><strong>Last Check-in:</strong></td>
                            <td>
                                [[if fleet_host.last_seen:]]
                                    [[=fleet_host.last_seen.strftime('%Y-%m-%d %H:%M:%S')]]
                                [[else:]]
                                    <span class="text-muted">Never</span>
                                [[pass]]
                            </td>
                        </tr>
                    </table>
                [[else:]]
                    <div class="text-center text-muted">
                        <i class="bi bi-shield-x fs-1"></i>
                        <div class="mt-2">Not enrolled in Fleet</div>
                        <div class="small">Deploy with OSQuery to enable monitoring</div>
                    </div>
                [[pass]]
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Deployment History -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Deployment History</h5>
            </div>
            <div class="card-body">
                [[if deployments:]]
                    <div class="deployment-timeline">
                        [[for deployment in deployments:]]
                            <div class="timeline-item [[=deployment.status.lower()]]">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">[[=deployment.deployment_name]]</h6>
                                        <p class="mb-1 text-muted">[[=deployment.description or 'No description']]</p>
                                        <small class="text-muted">
                                            Started [[=deployment.created_on.strftime('%Y-%m-%d %H:%M')]]
                                            by [[=deployment.created_by]]
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        [[status_class = 'secondary']]
                                        [[if deployment.status == 'Completed':]]
                                            [[status_class = 'success']]
                                        [[elif deployment.status == 'Failed':]]
                                            [[status_class = 'danger']]
                                        [[elif deployment.status in ['Running', 'Pending']:]]
                                            [[status_class = 'primary']]
                                        [[pass]]
                                        <span class="badge bg-[[=status_class]]">[[=deployment.status]]</span>
                                        <div class="small text-muted mt-1">[[=deployment.progress]]%</div>
                                    </div>
                                </div>
                                
                                [[if deployment.status in ['Running', 'Pending']:]]
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar" style="width: [[=deployment.progress]]%"></div>
                                    </div>
                                [[pass]]
                            </div>
                        [[pass]]
                    </div>
                [[else:]]
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-clock fs-1"></i>
                        <div class="mt-2">No deployment history</div>
                        <div class="small">Deploy this server to see history here</div>
                    </div>
                [[pass]]
            </div>
        </div>
    </div>

    <!-- OSQuery Results -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-search"></i> Recent OSQuery Results</h5>
            </div>
            <div class="card-body">
                [[if osquery_results:]]
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Query</th>
                                    <th>Results</th>
                                    <th>Time</th>
                                    <th>Execution</th>
                                </tr>
                            </thead>
                            <tbody>
                                [[for result in osquery_results:]]
                                    <tr>
                                        <td>
                                            <strong>[[=result.query_name]]</strong>
                                        </td>
                                        <td>
                                            [[try:]]
                                                [[import json]]
                                                [[data = json.loads(result.result_data) if result.result_data else []]]
                                                [[count = len(data) if isinstance(data, list) else 1]]
                                                <span class="badge bg-info">[[=count]] rows</span>
                                            [[except:]]
                                                <span class="text-muted">-</span>
                                            [[pass]]
                                        </td>
                                        <td class="small text-muted">
                                            [[=result.created_on.strftime('%m/%d %H:%M')]]
                                        </td>
                                        <td class="small">
                                            [[if result.execution_time:]]
                                                [[=f'{result.execution_time:.2f}s']]
                                            [[else:]]
                                                -
                                            [[pass]]
                                        </td>
                                    </tr>
                                [[pass]]
                            </tbody>
                        </table>
                    </div>
                [[else:]]
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-1"></i>
                        <div class="mt-2">No OSQuery results</div>
                        <div class="small">Results will appear here after OSQuery queries are executed</div>
                    </div>
                [[pass]]
            </div>
        </div>
    </div>
</div>

<!-- System Logs -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-journal-text"></i> System Logs</h5>
    </div>
    <div class="card-body">
        [[if logs:]]
            <div class="log-viewer" style="max-height: 400px;">
                [[for log in logs:]]
                    <div class="log-entry log-[[=log.level.lower()]]">
                        <span class="log-timestamp">[[=log.created_on.strftime('%H:%M:%S')]]</span>
                        <span class="log-level">[[[=log.level]]]</span>
                        <span class="log-message">[[=log.message]]</span>
                    </div>
                [[pass]]
            </div>
        [[else:]]
            <div class="text-center text-muted py-4">
                <i class="bi bi-journal fs-1"></i>
                <div class="mt-2">No logs found</div>
                <div class="small">System logs for this server will appear here</div>
            </div>
        [[pass]]
    </div>
</div>
[[end]]

[[block page_scripts]]
<script>
// Power control actions
function powerAction(serverId, action) {
    if (!confirm(`Are you sure you want to ${action} this server?`)) {
        return;
    }
    
    fetch(`/api/servers/power/${serverId}/${action}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            MaaSPortal.showMessage('success', data.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            MaaSPortal.showMessage('danger', data.error);
        }
    })
    .catch(error => {
        MaaSPortal.showMessage('danger', 'Failed to execute power action: ' + error.message);
    });
}

// Refresh server status
function refreshServerStatus() {
    const serverId = [[=server.id]];
    
    fetch(`/api/servers/status/${serverId}`)
    .then(response => response.json())
    .then(data => {
        if (data.server) {
            // Update status display
            location.reload();
        }
    })
    .catch(error => {
        MaaSPortal.showMessage('danger', 'Failed to refresh server status: ' + error.message);
    });
}

// Auto-refresh every 30 seconds
setInterval(() => {
    refreshServerStatus();
}, 30000);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(element => {
        new bootstrap.Tooltip(element);
    });
});
</script>
[[end]]