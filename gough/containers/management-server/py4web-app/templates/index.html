[[extend 'layout.html']]

[[block page_content]]
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-speedometer2"></i> Infrastructure Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Total Servers</h5>
                        <h2 class="mb-0">[[=stats['total_servers']]]</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-servers fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="[[=URL('servers/list')]]" class="text-white text-decoration-none">
                    View Details <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Active Jobs</h5>
                        <h2 class="mb-0">[[=stats['active_jobs']]]</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-play-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="[[=URL('jobs/active')]]" class="text-white text-decoration-none">
                    View Active <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Completed</h5>
                        <h2 class="mb-0">[[=stats['completed_jobs']]]</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="[[=URL('jobs/completed')]]" class="text-white text-decoration-none">
                    View Completed <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-danger text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Failed Jobs</h5>
                        <h2 class="mb-0">[[=stats['failed_jobs']]]</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="[[=URL('jobs/failed')]]" class="text-white text-decoration-none">
                    View Failed <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Server Status Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Server Status Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="serverStatusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> Recent Activity
                </h5>
                <a href="[[=URL('logs')]]" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    [[for log in recent_logs:]]
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                [[if log.level == 'ERROR':]]
                                <span class="badge bg-danger">[[=log.level]]</span>
                                [[elif log.level == 'WARNING':]]
                                <span class="badge bg-warning">[[=log.level]]</span>
                                [[elif log.level == 'INFO':]]
                                <span class="badge bg-info">[[=log.level]]</span>
                                [[else:]]
                                <span class="badge bg-secondary">[[=log.level]]</span>
                                [[pass]]
                                [[=log.component.upper()]]
                            </h6>
                            <small>[[=log.created_on.strftime('%H:%M:%S')]]</small>
                        </div>
                        <p class="mb-1">[[=log.message]]</p>
                        [[if log.details:]]
                        <small class="text-muted">[[=log.details[:100]]]...</small>
                        [[pass]]
                    </div>
                    [[pass]]
                    [[if not recent_logs:]]
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-info-circle"></i> No recent activity
                    </div>
                    [[pass]]
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="[[=URL('maas/dashboard')]]" class="btn btn-outline-primary btn-lg w-100">
                            <i class="bi bi-hdd-network"></i><br>
                            Manage Servers
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="[[=URL('servers/deploy')]]" class="btn btn-outline-success btn-lg w-100">
                            <i class="bi bi-play-circle"></i><br>
                            Deploy Server
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="[[=URL('cloud_init/templates')]]" class="btn btn-outline-info btn-lg w-100">
                            <i class="bi bi-file-earmark-code"></i><br>
                            Cloud-Init Templates
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="[[=URL('fleetdm/dashboard')]]" class="btn btn-outline-warning btn-lg w-100">
                            <i class="bi bi-shield-check"></i><br>
                            Security Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
[[end]]

[[block page_scripts]]
<script>
// Server Status Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('serverStatusChart').getContext('2d');
    const chartData = {
        labels: [[=XML(status_chart_data['labels'])]],
        datasets: [{
            data: [[=XML(status_chart_data['data'])]],
            backgroundColor: [
                '#0d6efd',
                '#198754',
                '#ffc107',
                '#dc3545',
                '#6f42c1',
                '#fd7e14'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
    
    new Chart(ctx, {
        type: 'pie',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Auto-refresh status indicator
    setInterval(updateSystemStatus, 30000);
});

function updateSystemStatus() {
    fetch('[[=URL("api/status")]]')
        .then(response => response.json())
        .then(data => {
            const statusIcon = document.getElementById('status-icon');
            if (data.status === 'ok') {
                statusIcon.className = 'bi bi-circle-fill text-success';
            } else {
                statusIcon.className = 'bi bi-circle-fill text-danger';
            }
        })
        .catch(error => {
            console.error('Error checking system status:', error);
            const statusIcon = document.getElementById('status-icon');
            statusIcon.className = 'bi bi-circle-fill text-warning';
        });
}
</script>
[[end]]