#cloud-config
# Docker Host Configuration
# Extends base-server with Docker-specific optimizations

# Import base configuration
merge_how: 'dict(recurse_array,no_replace)+list(append)'

# Additional Docker-focused packages
packages:
  - docker-compose
  - ctop
  - dive
  - docker-registry
  - portainer-agent

# Docker-specific system configuration
write_files:
  # Enhanced Docker daemon configuration for production
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "50m",
          "max-file": "5"
        },
        "storage-driver": "overlay2",
        "storage-opts": [
          "overlay2.override_kernel_check=true"
        ],
        "dns": ["8.8.8.8", "8.8.4.4"],
        "dns-opts": ["ndots:2", "edns0"],
        "default-ulimits": {
          "nofile": {
            "Name": "nofile",
            "Hard": 64000,
            "Soft": 64000
          }
        },
        "max-concurrent-downloads": 10,
        "max-concurrent-uploads": 5,
        "metrics-addr": "0.0.0.0:9323",
        "experimental": false,
        "live-restore": true,
        "userland-proxy": false,
        "no-new-privileges": true,
        "seccomp-profile": "/etc/docker/seccomp.json",
        "registry-mirrors": [],
        "insecure-registries": []
      }
    permissions: '0644'

  # Docker security profile
  - path: /etc/docker/seccomp.json
    content: |
      {
        "defaultAction": "SCMP_ACT_ERRNO",
        "archMap": [
          {
            "architecture": "SCMP_ARCH_X86_64",
            "subArchitectures": [
              "SCMP_ARCH_X86",
              "SCMP_ARCH_X32"
            ]
          }
        ],
        "syscalls": [
          {
            "names": [
              "accept",
              "accept4",
              "access",
              "alarm",
              "bind",
              "brk",
              "chdir",
              "chmod",
              "chown",
              "clone",
              "close",
              "connect",
              "dup",
              "dup2",
              "execve",
              "exit",
              "exit_group",
              "fchdir",
              "fchmod",
              "fchown",
              "fcntl",
              "fork",
              "fstat",
              "fstatfs",
              "futex",
              "getcwd",
              "getdents",
              "getegid",
              "geteuid",
              "getgid",
              "getgroups",
              "getpid",
              "getppid",
              "getrlimit",
              "getsid",
              "getsockname",
              "getsockopt",
              "gettid",
              "gettimeofday",
              "getuid",
              "listen",
              "lseek",
              "lstat",
              "madvise",
              "mkdir",
              "mknod",
              "mmap",
              "mount",
              "mprotect",
              "munmap",
              "nanosleep",
              "open",
              "openat",
              "pipe",
              "poll",
              "prctl",
              "read",
              "readlink",
              "recvfrom",
              "recvmsg",
              "rename",
              "rmdir",
              "rt_sigaction",
              "rt_sigprocmask",
              "rt_sigreturn",
              "select",
              "sendmsg",
              "sendto",
              "setsid",
              "setsockopt",
              "socket",
              "socketpair",
              "stat",
              "statfs",
              "symlink",
              "sysinfo",
              "umask",
              "umount2",
              "unlink",
              "unshare",
              "wait4",
              "write"
            ],
            "action": "SCMP_ACT_ALLOW"
          }
        ]
      }
    permissions: '0644'

  # Docker Compose file for monitoring stack
  - path: /opt/docker/monitoring/docker-compose.yml
    content: |
      version: '3.8'
      
      services:
        # Portainer for container management
        portainer:
          image: portainer/portainer-ce:latest
          container_name: portainer
          restart: unless-stopped
          ports:
            - "9000:9000"
            - "9443:9443"
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - portainer_data:/data
          command: -H unix:///var/run/docker.sock
          networks:
            - monitoring
        
        # Watchtower for automatic updates
        watchtower:
          image: containrrr/watchtower:latest
          container_name: watchtower
          restart: unless-stopped
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
          environment:
            - WATCHTOWER_CLEANUP=true
            - WATCHTOWER_POLL_INTERVAL=3600
            - WATCHTOWER_INCLUDE_RESTARTING=true
          networks:
            - monitoring
        
        # Docker metrics exporter
        cadvisor:
          image: gcr.io/cadvisor/cadvisor:latest
          container_name: cadvisor
          restart: unless-stopped
          ports:
            - "8080:8080"
          volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
            - /dev/disk/:/dev/disk:ro
          privileged: true
          devices:
            - /dev/kmsg
          networks:
            - monitoring
      
      volumes:
        portainer_data:
      
      networks:
        monitoring:
          driver: bridge
    permissions: '0644'

  # System limits for Docker
  - path: /etc/systemd/system/docker.service.d/override.conf
    content: |
      [Service]
      LimitNOFILE=1048576
      LimitNPROC=1048576
      LimitCORE=infinity
      TasksMax=infinity
      OOMScoreAdjust=-500
    permissions: '0644'

  # Docker cleanup script
  - path: /usr/local/bin/docker-cleanup
    content: |
      #!/bin/bash
      # Docker cleanup script to free up space
      
      echo "Starting Docker cleanup..."
      
      # Remove stopped containers
      echo "Removing stopped containers..."
      docker container prune -f
      
      # Remove unused images
      echo "Removing unused images..."
      docker image prune -a -f
      
      # Remove unused volumes
      echo "Removing unused volumes..."
      docker volume prune -f
      
      # Remove unused networks
      echo "Removing unused networks..."
      docker network prune -f
      
      # Remove build cache
      echo "Removing build cache..."
      docker builder prune -f
      
      # Show remaining usage
      echo "Docker system usage after cleanup:"
      docker system df
      
      echo "Docker cleanup completed!"
    permissions: '0755'

  # Docker health check script
  - path: /usr/local/bin/docker-health
    content: |
      #!/bin/bash
      # Docker health monitoring script
      
      echo "=== Docker System Status ==="
      echo "Docker version: $(docker --version)"
      echo "Docker daemon status: $(systemctl is-active docker)"
      echo ""
      
      echo "=== System Resources ==="
      docker system df
      echo ""
      
      echo "=== Running Containers ==="
      docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Size}}"
      echo ""
      
      echo "=== Container Resource Usage ==="
      docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"
      echo ""
      
      echo "=== Docker Events (last 10) ==="
      docker events --since="1h" --until="now" | tail -10
    permissions: '0755'

  # Cron job for regular Docker cleanup
  - path: /etc/cron.d/docker-cleanup
    content: |
      # Docker cleanup cron job
      0 2 * * 0 root /usr/local/bin/docker-cleanup >> /var/log/docker-cleanup.log 2>&1
    permissions: '0644'

# Docker-specific system configuration
runcmd:
  # Create Docker directories
  - mkdir -p /opt/docker/{monitoring,apps,data}
  - mkdir -p /var/lib/docker-registry
  - chown -R maas:docker /opt/docker

  # Enable Docker experimental features
  - systemctl daemon-reload
  - systemctl restart docker

  # Install Docker monitoring stack
  - cd /opt/docker/monitoring && docker-compose up -d

  # Configure Docker log rotation
  - |
    cat > /etc/logrotate.d/docker << 'EOF'
    /var/lib/docker/containers/*/*.log {
      daily
      rotate 7
      compress
      delaycompress
      missingok
      notifempty
      copytruncate
    }
    EOF

  # Configure kernel parameters for Docker
  - |
    cat >> /etc/sysctl.conf << 'EOF'
    # Docker optimizations
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    net.ipv4.ip_forward = 1
    vm.max_map_count = 262144
    fs.file-max = 65536
    EOF
  - sysctl -p

  # UFW rules for Docker
  - ufw allow 2376/tcp comment "Docker daemon"
  - ufw allow 9000/tcp comment "Portainer"
  - ufw allow 8080/tcp comment "cAdvisor"

  # Install additional Docker tools
  - pip3 install docker-compose docker-py

  # Set up Docker registry authentication
  - mkdir -p /home/maas/.docker
  - chown maas:maas /home/maas/.docker

final_message: |
  Docker host configuration completed successfully!
  
  Additional features installed:
  - Portainer for container management (port 9000)
  - cAdvisor for container metrics (port 8080)  
  - Watchtower for automatic updates
  - Docker cleanup automation
  - Enhanced security and logging
  
  Useful commands:
  - docker-cleanup: Clean up unused Docker resources
  - docker-health: Check Docker system health
  - ctop: Real-time container metrics
  - dive: Analyze Docker images
  
  Management interfaces:
  - Portainer: http://[server-ip]:9000
  - cAdvisor: http://[server-ip]:8080
  
  The Docker monitoring stack is now running.