#cloud-config
# OSQuery-enabled server template for Gough Hypervisor
# Automatically installs and configures OSQuery with FleetDM enrollment

package_update: true
package_upgrade: true

packages:
  - python3-pip
  - curl
  - wget
  - git
  - htop
  - vim
  - net-tools
  - unzip
  - jq
  - gnupg
  - software-properties-common
  - ca-certificates
  - apt-transport-https
  - systemd

write_files:
  # OSQuery enrollment script
  - path: /opt/install-osquery.sh
    content: |
      #!/bin/bash
      set -e
      
      OSQUERY_VERSION="5.10.2"
      FLEETDM_URL="${FLEETDM_URL:-https://fleetdm:8443}"
      ENROLL_SECRET="${FLEET_ENROLL_SECRET}"
      
      echo "Installing OSQuery version $OSQUERY_VERSION"
      
      # Create directories
      mkdir -p /etc/osquery/certs
      mkdir -p /var/osquery
      mkdir -p /var/log/osquery
      
      # Download and install OSQuery
      cd /tmp
      wget "https://pkg.osquery.io/deb/osquery_${OSQUERY_VERSION}-1.linux_amd64.deb"
      dpkg -i "osquery_${OSQUERY_VERSION}-1.linux_amd64.deb" || apt-get install -f -y
      
      # Create enrollment secret
      if [ -n "$ENROLL_SECRET" ]; then
          echo "$ENROLL_SECRET" > /etc/osquery/enroll_secret
          chmod 600 /etc/osquery/enroll_secret
      fi
      
      # Download FleetDM certificate (with fallback)
      if ! curl -k "$FLEETDM_URL/api/v1/fleet/certificate" -o /etc/osquery/certs/server.crt 2>/dev/null; then
          echo "Warning: Could not download FleetDM certificate, using self-signed fallback"
          openssl req -x509 -newkey rsa:2048 -keyout /tmp/temp.key -out /etc/osquery/certs/server.crt -days 365 -nodes \
              -subj "/C=US/ST=CA/L=San Francisco/O=Fleet/CN=fleet" 2>/dev/null || true
      fi
      
      # Set permissions
      chown -R root:root /etc/osquery
      chown -R osquery:osquery /var/osquery /var/log/osquery 2>/dev/null || true
      
      # Clean up
      rm -f /tmp/osquery_*.deb /tmp/temp.key
      
      echo "OSQuery installation completed"
    permissions: '0755'
    owner: root:root
    
  # OSQuery configuration
  - path: /etc/osquery/osquery.flags
    content: |
      # OSQuery Configuration Flags for FleetDM Integration
      # Generated by Gough Hypervisor cloud-init
      
      --tls_hostname=__FLEETDM_HOSTNAME__
      --tls_server_certs=/etc/osquery/certs/
      --enroll_tls_endpoint=/api/v1/osquery/enroll
      --config_plugin=tls
      --config_tls_endpoint=/api/v1/osquery/config
      --config_tls_refresh=10
      --logger_plugin=tls
      --logger_tls_endpoint=/api/v1/osquery/log
      --logger_tls_period=10
      --disable_logging=false
      --host_identifier=uuid
      --enroll_secret_path=/etc/osquery/enroll_secret
      --disable_enrollment=false
      --enroll_cooldown=60
      --schedule_splay_percent=10
      --schedule_default_interval=3600
      --disable_carver=false
      --carver_start_endpoint=/api/v1/osquery/carve/begin
      --carver_continue_endpoint=/api/v1/osquery/carve/block
      --carver_block_size=8000000
      --events_max=50000
      --events_expiry=86400
      --database_path=/var/osquery/osquery.db
      --pidfile=/var/osquery/osquery.pidfile
      --disable_audit=false
      --audit_allow_config=true
      --audit_allow_sockets=true
      --verbose=false
      --alsologtostderr=false
      --disable_distributed=false
      --distributed_plugin=tls
      --distributed_interval=60
      --distributed_tls_max_attempts=3
      --extensions_socket=/var/osquery/osquery.em
      --extensions_timeout=3
      --pack_refresh_interval=3600
      --watchdog_memory_limit=150
      --watchdog_utilization_limit=20
      --tls_dump=false
      --enroll_tls_max_attempts=3
      --config_tls_max_attempts=3
      --logger_tls_max_attempts=3
    permissions: '0644'
    owner: root:root

  # OSQuery basic configuration
  - path: /etc/osquery/osquery.conf
    content: |
      {
        "options": {
          "config_plugin": "tls",
          "logger_plugin": "tls",
          "host_identifier": "uuid",
          "schedule_splay_percent": 10
        },
        "schedule": {
          "system_info": {
            "query": "SELECT hostname, cpu_brand, physical_memory FROM system_info;",
            "interval": 3600
          },
          "uptime": {
            "query": "SELECT days, hours, minutes FROM uptime;",
            "interval": 3600
          }
        },
        "decorators": {
          "load": [
            "SELECT uuid AS host_uuid FROM system_info;",
            "SELECT hostname FROM system_info;"
          ]
        }
      }
    permissions: '0644'
    owner: root:root

  # OSQuery systemd service
  - path: /etc/systemd/system/osquery.service
    content: |
      [Unit]
      Description=The osquery Endpoint Detection and Response Agent
      Documentation=https://osquery.io/docs/
      After=network.target syslog.service
      
      [Service]
      Type=notify
      ExecStart=/usr/bin/osqueryd --flagfile=/etc/osquery/osquery.flags --config_path=/etc/osquery/osquery.conf
      ExecReload=/bin/kill -SIGUSR1 $MAINPID
      Restart=always
      RestartSec=3
      TimeoutStartSec=60
      TimeoutStopSec=60
      User=root
      Group=root
      
      # Security settings
      NoNewPrivileges=yes
      PrivateTmp=yes
      ProtectSystem=strict
      ReadWritePaths=/var/osquery /var/log/osquery /etc/osquery
      
      [Install]
      WantedBy=multi-user.target
    permissions: '0644'
    owner: root:root

  # Gough agent registration script
  - path: /opt/register-gough-agent.sh
    content: |
      #!/bin/bash
      set -e
      
      MANAGEMENT_URL="${GOUGH_MANAGEMENT_URL:-http://management-server:8000}"
      HOSTNAME=$(hostname)
      SYSTEM_ID=$(dmidecode -s system-uuid 2>/dev/null || cat /proc/sys/kernel/random/uuid)
      
      echo "Registering with Gough Management Server: $MANAGEMENT_URL"
      
      # Gather system information
      SYSTEM_INFO=$(cat <<EOF
      {
        "hostname": "$HOSTNAME",
        "system_id": "$SYSTEM_ID",
        "ip_address": "$(ip route get 8.8.8.8 | awk '{print $7}' | head -1)",
        "os_info": "$(lsb_release -d -s 2>/dev/null || echo 'Unknown')",
        "kernel": "$(uname -r)",
        "architecture": "$(uname -m)",
        "memory_mb": $(free -m | awk '/^Mem:/{print $2}'),
        "cpu_cores": $(nproc),
        "registration_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
      }
      EOF
      )
      
      # Register with management server
      curl -X POST "$MANAGEMENT_URL/api/agents/register" \
           -H "Content-Type: application/json" \
           -d "$SYSTEM_INFO" \
           -o /tmp/registration_response.json \
           --max-time 30 \
           --retry 3 || echo "Registration with management server failed"
      
      if [ -f /tmp/registration_response.json ]; then
          echo "Registration response:"
          cat /tmp/registration_response.json
          rm -f /tmp/registration_response.json
      fi
      
      echo "Gough agent registration completed"
    permissions: '0755'
    owner: root:root

  # Health check and monitoring script
  - path: /opt/gough-health-check.sh
    content: |
      #!/bin/bash
      # Gough system health check script
      
      set -e
      
      echo "Gough System Health Check - $(date)"
      echo "=================================="
      
      # System information
      echo "System Information:"
      echo "  Hostname: $(hostname)"
      echo "  Uptime: $(uptime -p)"
      echo "  Load: $(uptime | cut -d',' -f3-)"
      echo "  Memory: $(free -h | grep ^Mem | awk '{print $3 "/" $2}')"
      echo "  Disk: $(df -h / | tail -1 | awk '{print $3 "/" $2 " (" $5 " used)"}')"
      echo ""
      
      # Service status
      echo "Service Status:"
      echo "  OSQuery: $(systemctl is-active osquery 2>/dev/null || echo 'inactive')"
      echo "  SSH: $(systemctl is-active ssh 2>/dev/null || echo 'inactive')"
      echo ""
      
      # Network connectivity
      echo "Network Connectivity:"
      if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
          echo "  Internet: OK"
      else
          echo "  Internet: Failed"
      fi
      
      if [ -n "${FLEETDM_URL}" ]; then
          FLEET_HOST=$(echo "${FLEETDM_URL}" | sed 's|https\?://||' | cut -d':' -f1)
          if ping -c 1 "$FLEET_HOST" >/dev/null 2>&1; then
              echo "  FleetDM: OK"
          else
              echo "  FleetDM: Failed"
          fi
      fi
      
      echo ""
      echo "Health check completed"
    permissions: '0755'
    owner: root:root

users:
  - name: maas
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - __SSH_PUBLIC_KEY__

  - name: gough-agent
    system: true
    shell: /bin/false
    home: /opt/gough-agent

groups:
  - osquery

runcmd:
  # Update system
  - apt-get update
  - apt-get upgrade -y
  
  # Create osquery user and group
  - groupadd -f osquery
  - useradd -r -g osquery -d /var/osquery -s /bin/false osquery 2>/dev/null || true
  
  # Create directories with proper permissions
  - mkdir -p /var/osquery /var/log/osquery
  - chown osquery:osquery /var/osquery /var/log/osquery
  - chmod 755 /var/osquery /var/log/osquery
  
  # Install OSQuery
  - /opt/install-osquery.sh
  
  # Configure FleetDM hostname in osquery.flags
  - sed -i "s/__FLEETDM_HOSTNAME__/${FLEETDM_HOSTNAME:-fleetdm:8443}/" /etc/osquery/osquery.flags
  
  # Enable and start OSQuery service
  - systemctl daemon-reload
  - systemctl enable osquery
  - systemctl start osquery
  
  # Wait for OSQuery to start
  - sleep 10
  
  # Register with Gough management server
  - /opt/register-gough-agent.sh
  
  # Set up health check cron job
  - echo "*/15 * * * * root /opt/gough-health-check.sh >> /var/log/gough-health.log 2>&1" >> /etc/crontab
  
  # Configure log rotation for gough logs
  - |
    cat > /etc/logrotate.d/gough << 'EOF'
    /var/log/gough-health.log {
        daily
        rotate 7
        compress
        delaycompress
        missingok
        notifempty
    }
    EOF

# Set timezone
timezone: UTC

# Configure SSH
ssh_pwauth: false
disable_root: true

# Configure automatic updates
package_update: true
package_upgrade: true
package_reboot_if_required: false

# Final message
final_message: |
  Gough Hypervisor server configuration completed!
  OSQuery agent installed and configured for FleetDM
  System registered with Gough management server
  Health monitoring enabled
  
  System Information:
  - Hostname: $HOSTNAME
  - IP Address: $(ip route get 8.8.8.8 | awk '{print $7}' | head -1)
  - OS: $(lsb_release -d -s)
  - Kernel: $(uname -r)
  
  Services Status:
  - OSQuery: $(systemctl is-active osquery)
  - SSH: $(systemctl is-active ssh)
  
  Configuration files:
  - OSQuery flags: /etc/osquery/osquery.flags
  - OSQuery config: /etc/osquery/osquery.conf
  - Health check script: /opt/gough-health-check.sh
  
  Logs:
  - OSQuery logs: /var/log/osquery/
  - Health check: /var/log/gough-health.log
  
  System is ready for Gough hypervisor management!